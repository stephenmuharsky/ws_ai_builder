{
  "name": "WF8 - Rejection Email Generation",
  "nodes": [
    {
      "parameters": {
        "content": "# WF8: REJECTION EMAIL GENERATION\n\n**Trigger:** Called by WF4 when admin rejects a lead\n\n**AI generates personalized rejection/nurture email based on reason:**\n- below_threshold_on_review → Nurturing tone, free resources\n- not_a_fit → Redirecting tone, alternative suggestions\n- incomplete_info → Inviting tone, request more info\n- other → Gracious general response\n\n**Max 120 words. Never mention AI or scoring.**",
        "height": 300,
        "width": 480,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-600, -100],
      "id": "sn-wf8",
      "name": "WF8 Overview"
    },
    {
      "parameters": {
        "workflowInputs": { "values": [{ "name": "leadId" }, { "name": "rejectionReason" }, { "name": "customNote" }] }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [-200, 200],
      "id": "wf8-trigger",
      "name": "Called from WF4"
    },
    {
      "parameters": {
        "operation": "get",
        "key": "=leadstate_{{ $json.leadId }}",
        "keyType": "hash"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [40, 200],
      "id": "get-lead-wf8",
      "name": "Get Lead State",
      "credentials": { "redis": { "id": "YOUR_REDIS_CRED_ID", "name": "Redis" } }
    },
    {
      "parameters": {
        "jsCode": "const input = $('Called from WF4').first().json;\nconst lead = $('Get Lead State').first().json;\n\nreturn [{ json: {\n  leadId: input.leadId,\n  email: lead.email,\n  fullName: lead.fullName,\n  firstName: (lead.fullName || '').split(' ')[0],\n  rejectionReason: input.rejectionReason,\n  customNote: input.customNote || '',\n  financialGoals: lead.financialGoals || '',\n  investableAssets: lead.investableAssets || ''\n} }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [280, 200],
      "id": "prep-rejection",
      "name": "Prep Rejection Context"
    },
    {
      "parameters": {
        "options": {
          "systemMessage": "You compose rejection/nurture emails for NorthStar Wealth Advisory, a financial advisory firm. Output email body ONLY as plain text — no JSON, no markdown.\n\n## REJECTION TYPES AND TONE\n\n### below_threshold_on_review\nTone: Nurturing. \"We'd love to work with you in the future.\"\nInclude: 2-3 free resources relevant to their goals. Invitation to reconnect.\n- Retirement → link to retirement calculator\n- Tax → CRA resources\n- General → Wealthsimple Invest, Financial Planning Standards Council\n\n### not_a_fit\nTone: Redirecting. \"We want to make sure you get the right help.\"\nInclude: 1-2 alternative suggestions. Debt management → credit counseling referral.\n\n### incomplete_info\nTone: Inviting. \"We'd love to learn more.\"\nInclude: Clear call-to-action to reply or resubmit.\n\n### other\nTone: Gracious. Generic thank-you with open door.\n\n## RULES\n- First name greeting only\n- Maximum 120 words\n- NEVER mention AI, scoring, algorithms, or internal processes\n- NEVER be specific about why rejected\n- Always end with forward-looking positive note\n- Plain text only"
        },
        "text": "=Rejection reason: {{ $json.rejectionReason }}\nCustom note from admin: {{ $json.customNote }}\nClient name: {{ $json.firstName }}\nFinancial goals: {{ $json.financialGoals }}\nAsset range: {{ $json.investableAssets }}"
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [520, 200],
      "id": "rejection-composer",
      "name": "Rejection Email Composer"
    },
    {
      "parameters": { "modelName": "models/gemini-2.5-flash", "options": { "temperature": 0.4 } },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [520, 420],
      "id": "gemini-rejection",
      "name": "Gemini (Rejection)",
      "credentials": { "googleGeminiApi": { "id": "YOUR_GEMINI_CRED_ID", "name": "Google Gemini" } }
    },
    {
      "parameters": {
        "jsCode": "// Build email with appropriate subject based on rejection type\nconst context = $('Prep Rejection Context').first().json;\nconst aiBody = $('Rejection Email Composer').first().json.output || $('Rejection Email Composer').first().json.text || '';\n\nconst subjectMap = {\n  'below_threshold_on_review': 'Resources to help you on your financial journey',\n  'not_a_fit': 'Some recommendations for your financial goals',\n  'incomplete_info': \"We'd love to learn more\",\n  'other': 'Thank you for your interest'\n};\n\nconst subject = (subjectMap[context.rejectionReason] || subjectMap['other']) + ' — NorthStar Wealth Advisory';\n\nreturn [{ json: {\n  to: context.email,\n  subject,\n  body: aiBody,\n  leadId: context.leadId\n} }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [800, 200],
      "id": "build-rejection-email",
      "name": "Build Email"
    },
    {
      "parameters": {
        "sendTo": "={{ $json.to }}",
        "subject": "={{ $json.subject }}",
        "message": "={{ $json.body }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [1040, 200],
      "id": "send-rejection",
      "name": "Send Rejection Email",
      "credentials": { "gmailOAuth2": { "id": "YOUR_GMAIL_CRED_ID", "name": "Gmail" } }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=leadstate_{{ $('Build Email').first().json.leadId }}",
        "value": "={{ JSON.stringify({ rejectionEmailSentAt: $now.toISO() }) }}",
        "keyType": "hash"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [1280, 200],
      "id": "redis-rejection-sent",
      "name": "Mark Rejection Sent",
      "credentials": { "redis": { "id": "YOUR_REDIS_CRED_ID", "name": "Redis" } }
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [800, 420],
      "id": "wf8-error",
      "name": "Catch WF8 Errors"
    },
    {
      "parameters": {
        "jsCode": "// Fallback: send generic rejection template on AI failure\nconst context = $('Prep Rejection Context').first().json;\nreturn [{ json: {\n  to: context.email,\n  subject: 'Thank you for your interest — NorthStar Wealth Advisory',\n  body: `Hi ${context.firstName},\\n\\nThank you for reaching out to NorthStar Wealth Advisory. We appreciate you sharing your financial goals with us.\\n\\nAt this time, we believe you may be better served by resources that more closely align with your current needs. Here are some excellent options:\\n\\n- Wealthsimple Invest (wealthsimple.com)\\n- Financial Planning Standards Council (fpsc.ca)\\n\\nShould your circumstances change, we'd love to hear from you again.\\n\\nWarm regards,\\nNorthStar Wealth Advisory`,\n  leadId: context.leadId\n} }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1040, 420],
      "id": "fallback-email",
      "name": "Fallback Template"
    },
    {
      "parameters": {
        "sendTo": "={{ $json.to }}",
        "subject": "={{ $json.subject }}",
        "message": "={{ $json.body }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [1280, 420],
      "id": "send-fallback",
      "name": "Send Fallback Email",
      "credentials": { "gmailOAuth2": { "id": "YOUR_GMAIL_CRED_ID", "name": "Gmail" } }
    }
  ],
  "connections": {
    "Called from WF4": { "main": [[{ "node": "Get Lead State", "type": "main", "index": 0 }]] },
    "Get Lead State": { "main": [[{ "node": "Prep Rejection Context", "type": "main", "index": 0 }]] },
    "Prep Rejection Context": { "main": [[{ "node": "Rejection Email Composer", "type": "main", "index": 0 }]] },
    "Rejection Email Composer": { "main": [[{ "node": "Build Email", "type": "main", "index": 0 }]] },
    "Gemini (Rejection)": { "ai_languageModel": [[{ "node": "Rejection Email Composer", "type": "ai_languageModel", "index": 0 }]] },
    "Build Email": { "main": [[{ "node": "Send Rejection Email", "type": "main", "index": 0 }]] },
    "Send Rejection Email": { "main": [[{ "node": "Mark Rejection Sent", "type": "main", "index": 0 }]] },
    "Catch WF8 Errors": { "main": [[{ "node": "Fallback Template", "type": "main", "index": 0 }]] },
    "Fallback Template": { "main": [[{ "node": "Send Fallback Email", "type": "main", "index": 0 }]] }
  },
  "active": false,
  "settings": { "executionOrder": "v1" },
  "versionId": "wf8-rejection-v1",
  "meta": { "instanceId": "northstar-pipeline" },
  "id": "wf8-rejection-email",
  "tags": [{ "name": "northstar" }, { "name": "rejection" }, { "name": "ai" }]
}
