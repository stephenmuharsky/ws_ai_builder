{
  "name": "MASTER_WS_AI_BUILDER_WF",
  "nodes": [
    {
      "parameters": {
        "content": "# WF1: INTAKE FORM WEBHOOK & AUTO-DISQUALIFICATION\n\n**Endpoint:** POST /webhook/intake-form\n\n**Flow:**\n1. Receive form submission from React intake form\n2. Validate all fields (format, required, business hours)\n3. Generate Lead ID (LEAD-YYYYMMDD-XXXX)\n4. Run disqualification rules (deterministic — NO AI)\n5. Route: Disqualified → saved to Airtable + Redis (NO immediate email) | Qualified → AI enrichment\n\n**48-HOUR GRACE PERIOD:** Disqualified leads are NOT emailed immediately.\nWF7 checks hourly and sends rejection email after 48h if admin hasn't overridden.\nThis gives the advisor time to review edge cases (e.g. someone relocating to a served province).\n\n**Data Layer:** Airtable (Leads table) + Redis (lead state hash)\n**Disqualification is DETERMINISTIC — no AI involvement.**",
        "height": 1436,
        "width": 2880,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -912,
        -64
      ],
      "id": "9e0fc22a-b4f3-48e3-92cd-3e4a41b9e511",
      "name": "WF1 Overview"
    },
    {
      "parameters": {
        "content": "### DISQUALIFICATION RULES ENGINE\n\n**Rule 1 — Jurisdiction:** Province must be in firm:config.served_provinces\n**Rule 2 — Minimum Assets:** Mapped numeric value must be >= firm:config.min_assets_threshold\n\n**Goal mismatch REMOVED** — goal alignment is a soft signal.\nIt's evaluated during AI enrichment (WF2) as part of advisor matching,\nnot as a hard disqualification gate. A high-value lead with an\nunexpected goal category still deserves human review.\n\n**Router uses disqualificationCount > 0 (avoids boolean coercion).**",
        "height": 380,
        "width": 440,
        "color": 6
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        176,
        336
      ],
      "id": "e3e31155-a1cd-401b-bede-95857d178a7c",
      "name": "Rules Engine Docs"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "intake-form",
        "responseMode": "responseNode",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, OPTIONS"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -768,
        832
      ],
      "id": "f39c08c0-c4d0-4a65-aaf9-0d06101572d6",
      "name": "Intake Form Webhook",
      "webhookId": "08ca3920-ebb8-4861-b7b4-62186b21be44"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body || $input.first().json;\nconst errors = [];\nconst requiredStrings = ['fullName', 'email', 'phone', 'province', 'investableAssets', 'annualIncome', 'investmentTimeline', 'riskTolerance', 'currentAdvisorSituation', 'preferredDate', 'preferredTime'];\nfor (const field of requiredStrings) {\n  if (!body[field] || String(body[field]).trim() === '') {\n    errors.push(`Missing required field: ${field}`);\n  }\n}\nif (!body.financialGoals || !Array.isArray(body.financialGoals) || body.financialGoals.length === 0) {\n  errors.push('financialGoals must be a non-empty array');\n}\nif (body.consentGiven !== true) {\n  errors.push('consentGiven must be true');\n}\nconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\nif (body.email && !emailRegex.test(body.email)) {\n  errors.push(`Invalid email format: ${body.email}`);\n}\nif (body.preferredDate) {\n  const pDate = new Date(body.preferredDate + 'T12:00:00');\n  const now = new Date();\n  if (pDate <= now) errors.push('preferredDate must be in the future');\n  const day = pDate.getDay();\n  if (day === 0 || day === 6) errors.push('preferredDate must be a weekday');\n}\nif (body.preferredTime) {\n  const [h, m] = body.preferredTime.split(':').map(Number);\n  if (h < 9 || h >= 17) errors.push('preferredTime must be between 09:00 and 17:00');\n}\nconst validAssets = ['under_25k', '25k_100k', '100k_250k', '250k_500k', '500k_1m', '1m_plus'];\nif (body.investableAssets && !validAssets.includes(body.investableAssets)) {\n  errors.push(`Invalid investableAssets value: ${body.investableAssets}`);\n}\nconst validTimelines = ['under_1yr', '1_3yr', '3_5yr', '5_10yr', '10_plus'];\nif (body.investmentTimeline && !validTimelines.includes(body.investmentTimeline)) {\n  errors.push(`Invalid investmentTimeline value: ${body.investmentTimeline}`);\n}\nconst validRisk = ['conservative', 'moderate', 'aggressive'];\nif (body.riskTolerance && !validRisk.includes(body.riskTolerance)) {\n  errors.push(`Invalid riskTolerance value: ${body.riskTolerance}`);\n}\nreturn [{ json: { valid: errors.length === 0, errors, formData: body } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -528,
        832
      ],
      "id": "db7e19f7-106d-46e8-acd6-653b36447068",
      "name": "Validate Intake Form"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "valid-check",
              "leftValue": "={{ $json.valid }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -288,
        832
      ],
      "id": "f6a1abeb-1ecd-408f-8715-536e58803d8c",
      "name": "Valid?"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, errors: $('Validate Intake Form').first().json.errors }) }}",
        "options": {
          "responseCode": 400
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        -64,
        1040
      ],
      "id": "a1d31b7b-afd0-4a56-9f04-618e0964c457",
      "name": "Return 400"
    },
    {
      "parameters": {
        "jsCode": "const now = new Date();\nconst year = now.getFullYear();\nconst month = String(now.getMonth() + 1).padStart(2, '0');\nconst day = String(now.getDate()).padStart(2, '0');\nconst rand = String(Math.floor(1000 + Math.random() * 9000));\nconst leadId = `LEAD-${year}${month}${day}-${rand}`;\nconst formData = $('Validate Intake Form').first().json.formData;\nconst goalsStr = Array.isArray(formData.financialGoals) ? formData.financialGoals.join(',') : formData.financialGoals;\nreturn [{ json: { leadId, submittedAt: now.toISOString(), ...formData, financialGoals: goalsStr } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -64,
        736
      ],
      "id": "156b677d-436b-4b19-82cd-0d55a28e40df",
      "name": "Generate Lead ID"
    },
    {
      "parameters": {
        "operation": "get",
        "key": "firm:config",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        176,
        736
      ],
      "id": "a2f0a34a-fb14-4e19-9909-5645c6a551a2",
      "name": "Get Firm Config",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// DISQUALIFICATION RULES ENGINE — Deterministic, NO AI\n// Only HARD regulatory/business rules here. Goal alignment is a SOFT signal handled by AI enrichment (WF2).\nconst lead = $('Generate Lead ID').first().json;\nlet configRaw = $('Get Firm Config').first().json;\nlet config;\nif (typeof configRaw === 'string') { config = JSON.parse(configRaw); }\nelse if (configRaw.data) { config = JSON.parse(configRaw.data); }\nelse { config = configRaw; }\n\nconst reasons = [];\n\n// RULE 1: JURISDICTION — Hard regulatory prohibition\nconst servedProvinces = config.served_provinces || ['ON', 'BC', 'AB', 'QC'];\nif (!servedProvinces.includes(lead.province)) { reasons.push('jurisdiction_not_served'); }\n\n// RULE 2: MINIMUM ASSETS — Fee structure mismatch\nconst assetMap = { 'under_25k': 12500, '25k_100k': 62500, '100k_250k': 175000, '250k_500k': 375000, '500k_1m': 750000, '1m_plus': 1500000 };\nconst minThreshold = Number(config.min_assets_threshold) || 100000;\nconst assetValue = assetMap[lead.investableAssets] || 0;\nif (assetValue < minThreshold) { reasons.push('below_asset_threshold'); }\n\n// NOTE: Goal mismatch was REMOVED from disqualification.\n// Goal alignment is evaluated during AI enrichment (WF2) as a soft signal.\n// A $1M+ lead shouldn't be auto-rejected because their stated goal\n// doesn't exactly match our list — that's a nuance decision for AI + human.\n\nreturn [{ json: { disqualified: reasons.length > 0, disqualificationCount: reasons.length, disqualificationReasons: reasons, leadId: lead.leadId, leadData: lead, assetNumeric: assetValue, config: { servedProvinces, minThreshold } } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        416,
        736
      ],
      "id": "17815adb-7f28-4e73-a013-c3723ab2c50c",
      "name": "Disqualification Rules Engine"
    },
    {
      "parameters": {
        "content": "## QUALIFIED PATH",
        "height": 180,
        "width": 360,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        832,
        480
      ],
      "id": "1865c0a7-8aa6-4d17-b73b-c7cfd63aeede",
      "name": "Qualified Path"
    },
    {
      "parameters": {
        "jsCode": "const data = $('Disqualification Rules Engine').first().json;\nconst lead = data.leadData;\nreturn [{ json: { key: `leadstate_${lead.leadId}`, status: 'PENDING_ENRICHMENT', leadId: lead.leadId, fullName: lead.fullName, email: lead.email, phone: lead.phone || '', province: lead.province, investableAssets: lead.investableAssets, annualIncome: lead.annualIncome, financialGoals: lead.financialGoals, investmentTimeline: lead.investmentTimeline, riskTolerance: lead.riskTolerance, currentAdvisorSituation: lead.currentAdvisorSituation, preferredDate: lead.preferredDate || '', preferredTime: lead.preferredTime || '', backupDate: lead.backupDate || '', backupTime: lead.backupTime || '', freeText: lead.freeText || '', submittedAt: lead.submittedAt, followUpCount: '0' } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        912,
        640
      ],
      "id": "f6b72f1c-8870-4704-862f-80c86805faf8",
      "name": "Prep Redis State (Qualified)"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $json.key }}",
        "value": "={{ JSON.stringify($json) }}",
        "keyType": "hash"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1152,
        640
      ],
      "id": "02740a50-7fe8-4f20-83e2-507c4b143e06",
      "name": "Set Lead State (Redis)",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "create",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "leadId": "={{ $('Prep Redis State (Qualified)').first().json.leadId }}",
            "fullName": "={{ $('Prep Redis State (Qualified)').first().json.fullName }}",
            "email": "={{ $('Prep Redis State (Qualified)').first().json.email }}",
            "phone": "={{ $('Prep Redis State (Qualified)').first().json.phone }}",
            "province": "={{ $('Prep Redis State (Qualified)').first().json.province }}",
            "investableAssets": "={{ $('Prep Redis State (Qualified)').first().json.investableAssets }}",
            "annualIncome": "={{ $('Prep Redis State (Qualified)').first().json.annualIncome }}",
            "financialGoals": "={{ $('Prep Redis State (Qualified)').first().json.financialGoals }}",
            "investmentTimeline": "={{ $('Prep Redis State (Qualified)').first().json.investmentTimeline }}",
            "riskTolerance": "={{ $('Prep Redis State (Qualified)').first().json.riskTolerance }}",
            "currentAdvisorSituation": "={{ $('Prep Redis State (Qualified)').first().json.currentAdvisorSituation }}",
            "preferredDate": "={{ $('Prep Redis State (Qualified)').first().json.preferredDate }}",
            "preferredTime": "={{ $('Prep Redis State (Qualified)').first().json.preferredTime }}",
            "backupDate": "={{ $('Prep Redis State (Qualified)').first().json.backupDate }}",
            "backupTime": "={{ $('Prep Redis State (Qualified)').first().json.backupTime }}",
            "freeText": "={{ $('Prep Redis State (Qualified)').first().json.freeText }}",
            "status": "PENDING_ENRICHMENT",
            "submittedAt": "={{ $('Prep Redis State (Qualified)').first().json.submittedAt }}",
            "followUpCount": 0
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        1392,
        640
      ],
      "id": "600ce687-8bba-4a99-88a0-a60db1fb672b",
      "name": "Create Lead in Airtable (Qualified)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, leadId: $('Prep Redis State (Qualified)').first().json.leadId, status: 'PENDING_ENRICHMENT', message: 'Your submission has been received. We will be in touch within 1 business day.' }) }}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1632,
        544
      ],
      "id": "214820af-be4d-49f7-9991-9e19aec10ebf",
      "name": "Return 200 (Qualified)"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "HfZqG2gp6J25webY",
          "mode": "list",
          "cachedResultUrl": "/workflow/HfZqG2gp6J25webY",
          "cachedResultName": "WF2 - AI Enrichment Pipeline"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "leadId": "={{ $('Prep Redis State (Qualified)').first().json.leadId }}"
          },
          "matchingColumns": [
            "leadId"
          ],
          "schema": [
            {
              "id": "leadId",
              "displayName": "leadId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        1728,
        752
      ],
      "id": "092e210c-8767-4c89-81b4-1bd75224b0f4",
      "name": "Trigger WF2 - Enrichment"
    },
    {
      "parameters": {
        "content": "## DISQUALIFIED PATH\n*48h grace period — no immediate email*\n*WF7 sends rejection after 48h if no admin override*",
        "height": 180,
        "width": 420,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        832,
        912
      ],
      "id": "9e7cc42f-5eae-42c1-9568-2c2913a16f15",
      "name": "Disqualified Path"
    },
    {
      "parameters": {
        "jsCode": "const data = $('Disqualification Rules Engine').first().json;\nconst lead = data.leadData;\nreturn [{ json: { key: `leadstate_${lead.leadId}`, status: 'DISQUALIFIED', leadId: lead.leadId, fullName: lead.fullName, email: lead.email, phone: lead.phone || '', province: lead.province, investableAssets: lead.investableAssets, annualIncome: lead.annualIncome, financialGoals: lead.financialGoals, investmentTimeline: lead.investmentTimeline, riskTolerance: lead.riskTolerance, currentAdvisorSituation: lead.currentAdvisorSituation, preferredDate: lead.preferredDate || '', preferredTime: lead.preferredTime || '', backupDate: lead.backupDate || '', backupTime: lead.backupTime || '', freeText: lead.freeText || '', submittedAt: lead.submittedAt, disqualificationReasons: data.disqualificationReasons.join(','), followUpCount: '0' } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        912,
        976
      ],
      "id": "69e10048-8846-41c5-83bd-ac81a3fcc4d8",
      "name": "Prep Redis State (Disqualified)"
    },
    {
      "parameters": {
        "operation": "set",
        "key": "={{ $json.key }}",
        "value": "={{ JSON.stringify($json) }}",
        "keyType": "hash"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        1152,
        976
      ],
      "id": "d756c836-d247-4fc0-a771-ee97584b90ad",
      "name": "Set Lead State (Disqualified)",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "create",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "leadId": "={{ $json.leadId }}",
            "fullName": "={{ $json.fullName }}",
            "email": "={{ $json.email }}",
            "phone": "={{ $json.phone }}",
            "province": "={{ $json.province }}",
            "investableAssets": "={{ $json.investableAssets }}",
            "annualIncome": "={{ $json.annualIncome }}",
            "financialGoals": "={{ $json.financialGoals }}",
            "investmentTimeline": "={{ $json.investmentTimeline }}",
            "riskTolerance": "={{ $json.riskTolerance }}",
            "currentAdvisorSituation": "={{ $json.currentAdvisorSituation }}",
            "preferredDate": "={{ $json.preferredDate }}",
            "preferredTime": "={{ $json.preferredTime }}",
            "backupDate": "={{ $json.backupDate }}",
            "backupTime": "={{ $json.backupTime }}",
            "freeText": "={{ $json.freeText }}",
            "status": "DISQUALIFIED",
            "disqualificationReason": "={{ $json.disqualificationReasons }}",
            "submittedAt": "={{ $json.submittedAt }}",
            "followUpCount": 0
          },
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        1392,
        976
      ],
      "id": "09f6511f-8bac-451e-b05d-892346f6fc4d",
      "name": "Create Lead in Airtable (Disqualified)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, leadId: $('Prep Redis State (Disqualified)').first().json.leadId, message: 'Your submission has been received. We will be in touch within 1 business day.' }) }}",
        "options": {
          "responseCode": 200
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1632,
        976
      ],
      "id": "e961221e-a4b6-40b3-9ef2-6c719a6b7a12",
      "name": "Return 200 (Disqualified)"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [
        912,
        1232
      ],
      "id": "41580cfc-0079-4116-95f1-0b08e5d5f863",
      "name": "Catch WF1 Errors"
    },
    {
      "parameters": {
        "sendTo": "admin@northstarwealth.ca",
        "subject": "WF1 Intake Error - NorthStar Pipeline",
        "message": "=Intake workflow error at {{ $now.toISO() }}\n\nError: {{ $json.error?.message || JSON.stringify($json) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        1152,
        1232
      ],
      "id": "aa517dab-c913-45a2-a9c9-ff7008a056e5",
      "name": "Send WF1 Error Alert",
      "webhookId": "db05face-4a16-4cbd-87c0-7ef4c162df7b",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "loose"
          },
          "conditions": [
            {
              "id": "disqualified-check",
              "leftValue": "={{ $json.disqualified }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "855a3b5d-faf0-4a17-a676-2e56c3adf1d7",
      "name": "Disqualification Router",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        656,
        736
      ]
    },
    {
      "parameters": {
        "content": "# WF2: AI ENRICHMENT PIPELINE (RAG-Enhanced)\n\n**Trigger:** Called by WF1 after lead passes disqualification\n\n**Flow:**\n1. Receive leadId from WF1\n2. Read lead from Airtable\n3. Load business data (advisors, service tiers) from Redis cache\n4. **RAG-Enhanced** AI Enrichment Agent generates structured profile\n   - Queries Pinecone vector store for firm policy context\n   - Uses NorthStar Comprehensive Policy Manual for suitability, tier, and risk assessment\n5. Update lead in Airtable with enrichment data\n6. Trigger WF3 - Availability Pre-Check\n\n**RAG Component:** Firm Policy Knowledge tool queries embedded compliance/policy docs from Pinecone (fed by WF13).\n\n**Simplified: No Redis for lead state. Airtable is source of truth.**",
        "height": 1456,
        "width": 2864,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1952,
        -96
      ],
      "id": "bf23211a-885c-4ab0-827b-85461fd3ff16",
      "name": "WF2 Overview"
    },
    {
      "parameters": {
        "workflowInputs": {
          "values": [
            {
              "name": "leadId"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        2352,
        304
      ],
      "id": "7bf16770-da56-43f3-9133-dae356edbe46",
      "name": "Called from WF1"
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "={leadId}='{{ $json.leadId }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        2592,
        304
      ],
      "id": "31a523eb-4075-49fa-9c04-9d5b580e3d7f",
      "name": "Get Lead from Airtable",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Verify lead exists and status is correct\nconst items = $input.all();\nif (!items || items.length === 0) {\n  throw new Error('Lead not found in Airtable');\n}\nconst record = items[0].json;\nconst fields = record.fields || record;\nconst status = fields.status;\nif (status !== 'PENDING_ENRICHMENT') {\n  throw new Error(`Lead ${fields.leadId} status is ${status}, expected PENDING_ENRICHMENT. Skipping.`);\n}\n// Pass through the Airtable record ID + all fields\nreturn [{ json: { airtableRecordId: record.id, ...fields } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2832,
        304
      ],
      "id": "02123069-6188-4db2-bd16-a642a48a18be",
      "name": "Verify Lead Status"
    },
    {
      "parameters": {
        "operation": "get",
        "key": "firm:advisors",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        3072,
        304
      ],
      "id": "8e929722-39c7-47df-b5b1-d39f5544568e",
      "name": "Get Advisors Cache",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "key": "firm:service_tiers",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        3312,
        304
      ],
      "id": "bc238dac-d35b-4de0-a9a3-fbaf601d9f10",
      "name": "Get Service Tiers Cache",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Merge lead data + business data for AI agent\nconst lead = $('Verify Lead Status').first().json;\nlet advisorsRaw = $('Get Advisors Cache').first().json;\nlet tiersRaw = $('Get Service Tiers Cache').first().json;\n\n// Parse Redis values - handle different return shapes\nlet advisors = null;\nlet tiers = null;\n\ntry {\n  if (typeof advisorsRaw === 'string' && advisorsRaw !== '') advisors = JSON.parse(advisorsRaw);\n  else if (advisorsRaw && advisorsRaw.data) advisors = JSON.parse(advisorsRaw.data);\n  else if (advisorsRaw && typeof advisorsRaw.propertyName === 'string' && advisorsRaw.propertyName !== 'null' && advisorsRaw.propertyName) advisors = JSON.parse(advisorsRaw.propertyName);\n} catch(e) { advisors = null; }\n\ntry {\n  if (typeof tiersRaw === 'string' && tiersRaw !== '') tiers = JSON.parse(tiersRaw);\n  else if (tiersRaw && tiersRaw.data) tiers = JSON.parse(tiersRaw.data);\n  else if (tiersRaw && typeof tiersRaw.propertyName === 'string' && tiersRaw.propertyName !== 'null' && tiersRaw.propertyName) tiers = JSON.parse(tiersRaw.propertyName);\n} catch(e) { tiers = null; }\n\n// Fallback: hardcoded advisor + tier data from Airtable if Redis cache is empty\nif (!advisors || !Array.isArray(advisors) || advisors.length === 0) {\n  advisors = [\n    {advisorId: 'ADV001', name: 'Michael Torres', specializations: 'tax_optimization,wealth_growth,estate_planning', currentCaseload: 18, maxCaseload: 25},\n    {advisorId: 'ADV002', name: 'Priya Sharma', specializations: 'retirement_planning,education_savings,tax_optimization', currentCaseload: 14, maxCaseload: 20},\n    {advisorId: 'ADV003', name: 'David Kim', specializations: 'estate_planning,wealth_growth,retirement_planning', currentCaseload: 22, maxCaseload: 25},\n    {advisorId: 'ADV004', name: 'Rachel Nguyen', specializations: 'debt_management,retirement_planning,education_savings', currentCaseload: 8, maxCaseload: 20}\n  ];\n}\n\nif (!tiers || !Array.isArray(tiers) || tiers.length === 0) {\n  tiers = [\n    {tierId: 'T1', tierName: 'Financial Planning', minAssets: '100k_250k', qualifyingGoals: 'retirement_planning,education_savings,debt_management,wealth_growth'},\n    {tierId: 'T2', tierName: 'Wealth Management', minAssets: '250k_500k', qualifyingGoals: 'retirement_planning,wealth_growth,tax_optimization,estate_planning'},\n    {tierId: 'T3', tierName: 'Executive Wealth', minAssets: '500k_1m', qualifyingGoals: 'retirement_planning,wealth_growth,tax_optimization,estate_planning'}\n  ];\n}\n\nreturn [{\n  json: {\n    leadData: lead,\n    advisors,\n    serviceTiers: tiers\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3552,
        304
      ],
      "id": "ffc23488-6641-445b-b242-e2fecac2a9fe",
      "name": "Merge Lead + Business Data"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Lead Data:\n{{ JSON.stringify($json.leadData, null, 2) }}\n\nAvailable Advisors:\n{{ JSON.stringify($json.advisors, null, 2) }}\n\nService Tiers:\n{{ JSON.stringify($json.serviceTiers, null, 2) }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are a client intake enrichment agent for NorthStar Wealth Advisory, a financial advisory firm in Toronto, Canada. Analyze intake form data and generate a structured assessment. Output JSON only — no explanations, no markdown.\n\n## CRITICAL: USE THE FIRM POLICY KNOWLEDGE TOOL\nBefore generating your assessment, you MUST query the 'Firm Policy Knowledge' tool to retrieve relevant firm policies. Make at least 2 queries:\n1. Query for service tier eligibility criteria and the client's specific financial goals\n2. Query for advisor matching rules, risk flag detection criteria, and suitability assessment guidelines\n\nUse the retrieved policy context to inform ALL of your assessments — tier recommendation, advisor ranking, risk flags, priority scoring, and conversation starters should all align with documented firm policies rather than generic financial advice.\n\n## OUTPUT SCHEMA\n{\n  \"profileSummary\": \"3-4 sentence natural language synthesis of the client's financial situation, goals, and notable signals. Write as if briefing a senior advisor.\",\n  \"recommendedServiceTier\": {\n    \"tierId\": \"string\",\n    \"tierName\": \"string\",\n    \"reasoning\": \"1-2 sentences explaining why this tier fits, referencing firm policy criteria\"\n  },\n  \"advisorMatchRanking\": [\n    {\n      \"advisorId\": \"string\",\n      \"advisorName\": \"string\",\n      \"matchScore\": 0-100,\n      \"reasoning\": \"1 sentence\"\n    }\n  ],\n  \"conversationStarters\": [\"3 suggested talking points, informed by firm's client engagement approach\"],\n  \"riskFlags\": [\n    {\n      \"flag\": \"short label\",\n      \"detail\": \"1-2 sentence explanation\",\n      \"severity\": \"LOW | MEDIUM | HIGH\"\n    }\n  ],\n  \"priorityScore\": \"HIGH | MEDIUM | LOW\",\n  \"priorityReasoning\": \"1-2 sentences\",\n  \"documentsToRequest\": [\"list of documents the client should prepare for the consultation\"]\n}\n\n## ADVISOR MATCHING RULES\n- Rank by: specialization overlap (40%), available capacity (30%), overall fit (30%)\n- Advisors at >=90% caseload ranked lower\n- Return ALL advisors ranked\n- Reference firm policy on advisor tier experience when ranking\n\n## RISK FLAG DETECTION\nQuery the firm policy tool for risk flag criteria. Common flags include:\n- Inheritance/windfall -> Liquidity event — immediate planning needed\n- Short timeline + aggressive risk -> Expectations management needed\n- Switching advisor -> Ask about pain points with previous advisor\n- Multiple competing goals -> Goal prioritization discussion needed\n- Divorce/separation -> Complex asset division likely, check vulnerable client indicators\n- Crypto/day trading/options -> May expect services outside firm scope\n- Quebec residency -> Civil law estate planning, French language requirements\n- Cross-border indicators (US mentions) -> Requires Tier 2+ service\n- If no flags -> empty array\n\n## DOCUMENTS TO REQUEST\nGenerate a personalized list based on client situation. Always include baseline: recent bank statements, most recent NOA from CRA, previous year's tax return.\n\n## PRIORITY SCORING\n- HIGH: Assets >= $500K OR urgency signals (inheritance, divorce, imminent retirement)\n- MEDIUM: Assets $100K-$500K with good fit\n- LOW: Assets $100K-$250K with single goal\n\n## CRITICAL: Output ONLY valid JSON. Never fabricate info. Ground assessments in firm policy context retrieved from the tool."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        3792,
        304
      ],
      "id": "4d8a3494-ec34-43af-8606-29342b581e8a",
      "name": "Lead Enrichment Agent"
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        3600,
        656
      ],
      "id": "68f95c05-863a-443b-95d5-115fad61e5d5",
      "name": "Gemini 2.5 Flash (Enrichment)",
      "credentials": {
        "googlePalmApi": {
          "id": "gKOxHvioCsyTdrwX",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"profileSummary\": { \"type\": \"string\" },\n    \"recommendedServiceTier\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"tierId\": { \"type\": \"string\" },\n        \"tierName\": { \"type\": \"string\" },\n        \"reasoning\": { \"type\": \"string\" }\n      },\n      \"required\": [\"tierId\", \"tierName\", \"reasoning\"]\n    },\n    \"advisorMatchRanking\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"advisorId\": { \"type\": \"string\" },\n          \"advisorName\": { \"type\": \"string\" },\n          \"matchScore\": { \"type\": \"number\" },\n          \"reasoning\": { \"type\": \"string\" }\n        },\n        \"required\": [\"advisorId\", \"advisorName\", \"matchScore\", \"reasoning\"]\n      }\n    },\n    \"conversationStarters\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } },\n    \"riskFlags\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"properties\": {\n          \"flag\": { \"type\": \"string\" },\n          \"detail\": { \"type\": \"string\" },\n          \"severity\": { \"type\": \"string\", \"enum\": [\"LOW\", \"MEDIUM\", \"HIGH\"] }\n        },\n        \"required\": [\"flag\", \"detail\", \"severity\"]\n      }\n    },\n    \"priorityScore\": { \"type\": \"string\", \"enum\": [\"HIGH\", \"MEDIUM\", \"LOW\"] },\n    \"priorityReasoning\": { \"type\": \"string\" },\n    \"documentsToRequest\": {\n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" },\n      \"description\": \"Specific documents the client should prepare for the consultation, tailored to their financial situation, goals, and risk flags.\"\n    }\n  },\n  \"required\": [\"profileSummary\", \"recommendedServiceTier\", \"advisorMatchRanking\", \"conversationStarters\", \"riskFlags\", \"priorityScore\", \"priorityReasoning\", \"documentsToRequest\"]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        4192,
        704
      ],
      "id": "316cbaa7-2aa9-44a3-b678-b6d9037468ac",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "jsCode": "// Merge enrichment results with lead data for Airtable update\nconst agentOutput = $('Lead Enrichment Agent').first().json;\nconst lead = $('Verify Lead Status').first().json;\n\n// Agent output may be at top level or nested under .output\nconst enrichment = agentOutput.output ? (typeof agentOutput.output === 'string' ? JSON.parse(agentOutput.output) : agentOutput.output) : agentOutput;\n\n// Top advisor for availability check\nconst topAdvisor = enrichment.advisorMatchRanking && enrichment.advisorMatchRanking[0]\n  ? enrichment.advisorMatchRanking[0]\n  : { advisorId: 'ADV001', advisorName: 'Michael Torres' };\n\nreturn [{\n  json: {\n    id: lead.airtableRecordId,\n    leadId: lead.leadId,\n    status: 'PENDING_REVIEW',\n    profileSummary: enrichment.profileSummary || '',\n    recommendedServiceTier: JSON.stringify(enrichment.recommendedServiceTier || {}),\n    advisorMatchRanking: JSON.stringify(enrichment.advisorMatchRanking || []),\n    conversationStarters: JSON.stringify(enrichment.conversationStarters || []),\n    riskFlags: JSON.stringify(enrichment.riskFlags || []),\n    documentsToRequest: JSON.stringify(enrichment.documentsToRequest || ['Recent bank statements (all accounts)', 'Most recent Notice of Assessment (NOA) from CRA', 'Previous year\\'s tax return']),\n    priorityScore: enrichment.priorityScore || 'MEDIUM',\n    priorityReasoning: enrichment.priorityReasoning || '',\n    topAdvisorId: topAdvisor.advisorId,\n    topAdvisorName: topAdvisor.advisorName,\n    preferredDate: lead.preferredDate || '',\n    preferredTime: lead.preferredTime || '',\n    backupDate: lead.backupDate || '',\n    backupTime: lead.backupTime || ''\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4080,
        304
      ],
      "id": "92c5155f-1d9c-4d5a-8ffa-33bd8f393a01",
      "name": "Merge Enrichment Results"
    },
    {
      "parameters": {
        "jsCode": "const errorData = $input.first().json;\nreturn [{ json: { error: errorData, action: 'ENRICHMENT_FAILED' } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2736,
        816
      ],
      "id": "472a22b1-23d4-45ff-b24c-71b89e558652",
      "name": "Handle Enrichment Error"
    },
    {
      "parameters": {
        "sendTo": "smuharsk@gmail.com",
        "subject": "WF2 Enrichment FAILED — NorthStar Pipeline",
        "message": "=AI Enrichment failed at {{ $now.toISO() }}\n\nError: {{ JSON.stringify($json.error) }}\n\nLead may need manual review.",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        2976,
        816
      ],
      "id": "e6d12fe8-d630-41ed-8647-33204b3d20bb",
      "name": "Send WF2 Error Alert",
      "webhookId": "5fbacab5-a916-42af-99dc-9a676572c249",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "He1n1ppcpk5MRFOo",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "leadId": "={{ $('Merge Enrichment Results').first().json.leadId }}",
            "topAdvisorId": "={{ $('Merge Enrichment Results').first().json.topAdvisorId }}",
            "preferredDate": "={{ $('Merge Enrichment Results').first().json.preferredDate }}",
            "preferredTime": "={{ $('Merge Enrichment Results').first().json.preferredTime }}",
            "backupDate": "={{ $('Merge Enrichment Results').first().json.backupDate }}",
            "backupTime": "={{ $('Merge Enrichment Results').first().json.backupTime }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "leadId",
              "displayName": "leadId",
              "type": "string"
            },
            {
              "id": "topAdvisorId",
              "displayName": "topAdvisorId",
              "type": "string"
            },
            {
              "id": "preferredDate",
              "displayName": "preferredDate",
              "type": "string"
            },
            {
              "id": "preferredTime",
              "displayName": "preferredTime",
              "type": "string"
            },
            {
              "id": "backupDate",
              "displayName": "backupDate",
              "type": "string"
            },
            {
              "id": "backupTime",
              "displayName": "backupTime",
              "type": "string"
            }
          ]
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "30c2783f-758c-48e2-8420-1c99da42de75",
      "name": "Trigger WF3 - Availability",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        4560,
        304
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.id }}",
            "status": "={{ $json.status }}",
            "priorityScore": "={{ $json.priorityScore }}",
            "priorityReasoning": "={{ $json.priorityReasoning }}",
            "profileSummary": "={{ $json.profileSummary }}",
            "recommendedServiceTier": "={{ $json.recommendedServiceTier }}",
            "advisorMatchRanking": "={{ $json.advisorMatchRanking }}",
            "riskFlags": "={{ $json.riskFlags }}",
            "conversationStarters": "={{ $json.conversationStarters }}",
            "documentsToRequest": "={{ $json.documentsToRequest }}",
            "assignedAdvisorId": "={{ $json.topAdvisorId }}",
            "assignedAdvisorName": "={{ $json.topAdvisorName }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "ad44f0ff-50d3-46ae-82a6-6e3b149cb1af",
      "name": "Update Lead in Airtable",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        4320,
        304
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "description": "NorthStar Wealth Advisory internal policy documents covering: service tier eligibility criteria and pricing, client suitability assessment frameworks, KYC requirements, risk tolerance vs risk capacity alignment rules, advisor specialization details and caseload policies, geographic and regulatory requirements by province, vulnerable client indicators, priority scoring criteria, and lead qualification standards. Query this tool whenever you need to assess suitability, determine service tier, evaluate risk flags, rank advisors, or generate conversation starters based on firm-specific policies.",
        "topK": 6
      },
      "id": "c83ade01-171e-4581-92eb-309d30dd8da0",
      "name": "Firm Policy Knowledge",
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1.1,
      "position": [
        3824,
        720
      ]
    },
    {
      "parameters": {
        "pineconeIndex": {
          "__rl": true,
          "mode": "list",
          "value": "northstar-policies",
          "cachedResultName": "northstar-policies"
        },
        "options": {}
      },
      "id": "769467bd-9859-47ae-8e3e-5daaf4c3fc6f",
      "name": "Pinecone (Policy Retrieval)",
      "type": "@n8n/n8n-nodes-langchain.vectorStorePinecone",
      "typeVersion": 1,
      "position": [
        3696,
        944
      ],
      "credentials": {
        "pineconeApi": {
          "id": "yIemhxUEm2rJwniw",
          "name": "PineconeApi account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "models/gemini-embedding-001"
      },
      "id": "35947621-8974-4782-a7cb-864dca923636",
      "name": "Embeddings Gemini (Retrieval)",
      "type": "@n8n/n8n-nodes-langchain.embeddingsGoogleGemini",
      "typeVersion": 1,
      "position": [
        3616,
        1104
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "gKOxHvioCsyTdrwX",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        4048,
        928
      ],
      "id": "eb16f077-b171-4a39-be53-9d824b3aee37",
      "name": "Google Gemini Chat Model",
      "credentials": {
        "googlePalmApi": {
          "id": "gKOxHvioCsyTdrwX",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "content": "# WF3: AVAILABILITY PRE-CHECK\n\n**Trigger:** Called by WF2 after enrichment\n\n**Flow:**\n1. Receive leadId + advisor/time data from WF2\n2. Check availability against cached data\n3. Set availability status\n4. Find lead in Airtable, prep update\n5. Update lead status to PENDING_REVIEW\n\n**Simplified: Airtable is source of truth. No Redis for lead state.**",
        "height": 1076,
        "width": 1536,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        4832,
        0
      ],
      "id": "48b86474-3f95-4125-9eb1-722e8b17134c",
      "name": "WF3 Overview"
    },
    {
      "parameters": {
        "operation": "get",
        "key": "firm:advisor_availability",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        5024,
        464
      ],
      "id": "45183ad5-810d-486e-baaa-82354aca92a0",
      "name": "Get Availability Cache",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "key": "firm:config",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        5264,
        464
      ],
      "id": "4f0ec2cc-3c4a-40d1-9b2f-4f6730c059ad",
      "name": "Get Config",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Check availability for preferred and backup times\nconst input = $('Called from WF1').first().json;\nlet availRaw = $('Get Availability Cache').first().json;\nlet configRaw = $('Get Config').first().json;\n\nconst leadId = input.leadId || input.body?.leadId || '';\nif (!leadId) throw new Error('No leadId received from WF2. Input keys: ' + Object.keys(input).join(', '));\n\n// Parse Redis values with null safety\nlet availability = [];\nlet config = {};\n\ntry {\n  if (typeof availRaw === 'string' && availRaw) availability = JSON.parse(availRaw);\n  else if (availRaw && availRaw.data) availability = JSON.parse(availRaw.data);\n  else if (availRaw && availRaw.propertyName && availRaw.propertyName !== 'null') availability = JSON.parse(availRaw.propertyName);\n} catch(e) { availability = []; }\n\ntry {\n  if (typeof configRaw === 'string' && configRaw) config = JSON.parse(configRaw);\n  else if (configRaw && configRaw.data) config = JSON.parse(configRaw.data);\n  else if (configRaw && configRaw.propertyName && configRaw.propertyName !== 'null') config = JSON.parse(configRaw.propertyName);\n} catch(e) { config = {}; }\n\nconst duration = Number(config.consultation_duration_minutes) || 60;\nconst buffer = Number(config.consultation_buffer_minutes) || 15;\nconst totalBlock = duration + buffer;\n\nfunction timeToMinutes(timeStr) {\n  if (!timeStr) return 0;\n  const [h, m] = timeStr.split(':').map(Number);\n  return h * 60 + (m || 0);\n}\n\nfunction checkSlot(date, time, advisorId) {\n  if (!date || !time) return { available: false, reason: 'missing_data' };\n  if (!availability || availability.length === 0) return { available: false, reason: 'no_availability_data' };\n  const row = availability.find(r => r.date === date && r.advisorId === advisorId);\n  if (!row) return { available: false, reason: 'no_availability_data' };\n  if (row.workingHours === 'OFF') return { available: false, reason: 'day_off' };\n  const [startH, endH] = row.workingHours.split('-').map(s => s.trim());\n  const workStart = timeToMinutes(startH);\n  const workEnd = timeToMinutes(endH);\n  const reqStart = timeToMinutes(input.preferredTime || time);\n  const reqEnd = reqStart + totalBlock;\n  if (reqStart < workStart || reqEnd > workEnd) return { available: false, reason: 'outside_hours' };\n  return { available: true };\n}\n\nconst preferred = checkSlot(input.preferredDate, input.preferredTime, input.topAdvisorId);\n\nlet result;\nif (preferred.available) {\n  result = {\n    availabilityStatus: 'PREFERRED_AVAILABLE',\n    suggestedBooking: JSON.stringify({ advisorId: input.topAdvisorId, date: input.preferredDate, time: input.preferredTime })\n  };\n} else {\n  const backup = checkSlot(input.backupDate, input.backupTime, input.topAdvisorId);\n  if (backup.available) {\n    result = {\n      availabilityStatus: 'BACKUP_AVAILABLE',\n      suggestedBooking: JSON.stringify({ advisorId: input.topAdvisorId, date: input.backupDate, time: input.backupTime })\n    };\n  } else {\n    result = {\n      availabilityStatus: 'SCHEDULING_REQUIRED',\n      suggestedBooking: ''\n    };\n  }\n}\n\nreturn [{ json: { leadId: leadId, ...result } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5504,
        464
      ],
      "id": "ae07d9b4-6a40-4817-91dc-fb7b6627eb11",
      "name": "Check Preferred & Backup Availability"
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "={leadId}='{{ $json.leadId }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        5744,
        464
      ],
      "id": "62cace24-d45e-4506-9660-71dc393742c7",
      "name": "Find Lead in Airtable",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Prep the Airtable update with correct record ID\nconst avail = $('Check Preferred & Backup Availability').first().json;\nconst airtableRecord = $('Find Lead in Airtable').first().json;\n\n// Get the Airtable record id\nconst recordId = airtableRecord.id;\n\nif (!recordId) {\n  throw new Error('Could not find lead ' + avail.leadId + ' in Airtable');\n}\n\nreturn [{\n  json: {\n    id: recordId,\n    status: 'PENDING_REVIEW',\n    availabilityStatus: avail.availabilityStatus,\n    suggestedBooking: avail.suggestedBooking || ''\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5984,
        464
      ],
      "id": "913f5226-6666-4061-a479-0320b4222066",
      "name": "Prep Airtable Update"
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.id }}",
            "status": "={{ $json.status }}",
            "availabilityStatus": "={{ $json.availabilityStatus }}",
            "suggestedBooking": "={{ $json.suggestedBooking }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        6224,
        464
      ],
      "id": "2d2aba95-b84d-4540-8a23-a4591e1563d5",
      "name": "Update Lead in Airtable (Status)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "content": "# WF4: DASHBOARD ACTION ENDPOINTS\n\n**6 endpoints. Dashboard reads Airtable directly for lead lists.**\n\n**ACTIONS:**\n1. POST /api/leads/approve → APPROVED → triggers WF5\n2. POST /api/leads/reject → REJECTED → triggers WF8\n3. POST /api/leads/override → PENDING_ENRICHMENT → triggers WF2\n4. POST /api/leads/request-info → AWAITING_INFO\n5. POST /api/leads/confirm-reject → REJECTED (skip 48h grace) → triggers WF8\n\n**DATA:**\n6. GET /api/leads/disqualified → All DISQUALIFIED leads with full form data, DQ reasons, grace period countdown\n\n**Override flow:** Admin overrides DQ lead → status=PENDING_ENRICHMENT → WF2 enriches → status=PENDING_REVIEW → appears in New Leads with full AI data",
        "height": 2416,
        "width": 1916,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        6384,
        -528
      ],
      "id": "526f7912-5236-4c20-aea4-2f53a83432a0",
      "name": "WF4 Overview"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/leads/approve",
        "responseMode": "responseNode",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        6544,
        32
      ],
      "id": "decef178-7669-45cd-8038-667cd1880b45",
      "name": "POST /api/leads/approve",
      "webhookId": "approve-wh"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body || $input.first().json;\nreturn [{ json: {\n  leadId: body.leadId,\n  assignedAdvisorId: body.assignedAdvisorId || '',\n  assignedAdvisorName: body.assignedAdvisorName || '',\n  approvedAt: new Date().toISOString()\n}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6784,
        32
      ],
      "id": "a4433c00-87db-4867-b67b-07b5769fa127",
      "name": "Process Approval"
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "={leadId}='{{ $json.leadId }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        7024,
        32
      ],
      "id": "2e8c0056-cdd1-44f7-b57c-58780aa3850f",
      "name": "Find Lead (Approve)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const approval = $('Process Approval').first().json;\nconst record = $('Find Lead (Approve)').first().json;\nif (!record || !record.id) throw new Error('Lead not found: ' + approval.leadId);\n\n// Resolve advisor name from ID if not provided by frontend\nlet advisorName = approval.assignedAdvisorName || '';\nlet advisorId = approval.assignedAdvisorId || '';\n\n// If we have an ID but no name, try to get it from the lead's enrichment data\nif (advisorId && !advisorName) {\n  try {\n    const ranking = JSON.parse(record.advisorMatchRanking || '[]');\n    const match = ranking.find(a => a.advisorId === advisorId);\n    if (match) advisorName = match.advisorName;\n  } catch(e) {}\n}\n\n// Fallback: hardcoded advisor map (from Advisor Info table)\nif (advisorId && !advisorName) {\n  const advisorMap = {\n    'ADV001': 'Michael Torres',\n    'ADV002': 'Priya Sharma', \n    'ADV003': 'David Kim',\n    'ADV004': 'Rachel Nguyen'\n  };\n  advisorName = advisorMap[advisorId] || '';\n}\n\nreturn [{ json: {\n  id: record.id,\n  status: 'APPROVED',\n  assignedAdvisorId: advisorId,\n  assignedAdvisorName: advisorName,\n  approvedAt: approval.approvedAt\n}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7264,
        32
      ],
      "id": "c7f9ad61-72f1-434f-a994-1042c8b8c4b6",
      "name": "Prep Approve Update"
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.id }}",
            "status": "={{ $json.status }}",
            "assignedAdvisorId": "={{ $json.assignedAdvisorId }}",
            "assignedAdvisorName": "={{ $json.assignedAdvisorName }}",
            "approvedAt": "={{ $json.approvedAt }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        7504,
        32
      ],
      "id": "847bb291-79e5-4481-a621-55d605285d36",
      "name": "Update Lead (Approve)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, leadId: $('Process Approval').first().json.leadId, status: 'APPROVED' }) }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        7744,
        32
      ],
      "id": "49401892-3954-4478-93c7-5baed6c4ee00",
      "name": "Return 200 (Approve)"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/leads/reject",
        "responseMode": "responseNode",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        6544,
        336
      ],
      "id": "4fc8ab21-2d82-43c3-a5b0-d55f076ce066",
      "name": "POST /api/leads/reject",
      "webhookId": "reject-wh"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body || $input.first().json;\nreturn [{ json: {\n  leadId: body.leadId,\n  rejectionReason: body.rejectionReason || 'other',\n  rejectedAt: new Date().toISOString()\n}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6784,
        336
      ],
      "id": "5955592c-6af9-4039-a410-5fc99de7322f",
      "name": "Parse Reject"
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "={leadId}='{{ $json.leadId }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        7024,
        336
      ],
      "id": "cab708df-a89f-43ce-88d9-f38fb99042e2",
      "name": "Find Lead (Reject)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const rej = $('Parse Reject').first().json;\nconst record = $('Find Lead (Reject)').first().json;\nif (!record || !record.id) throw new Error('Lead not found: ' + rej.leadId);\nreturn [{ json: {\n  id: record.id,\n  status: 'REJECTED',\n  rejectionReason: rej.rejectionReason,\n  rejectedAt: rej.rejectedAt\n}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7264,
        336
      ],
      "id": "b61a29e4-b96f-4479-9516-8cca4e986a82",
      "name": "Prep Reject Update"
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.id }}",
            "status": "={{ $json.status }}",
            "rejectionReason": "={{ $json.rejectionReason }}",
            "rejectedAt": "={{ $json.rejectedAt }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        7504,
        336
      ],
      "id": "f0d92f9e-82f5-422e-8876-ac85d42fc7ee",
      "name": "Update Lead (Reject)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, leadId: $('Parse Reject').first().json.leadId, status: 'REJECTED' }) }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        7744,
        336
      ],
      "id": "29719659-8193-41b6-9b3f-898520801bbc",
      "name": "Return 200 (Reject)"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/leads/override",
        "responseMode": "responseNode",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        6544,
        640
      ],
      "id": "03c08331-c425-4e6b-a613-acaa6f153ad1",
      "name": "POST /api/leads/override",
      "webhookId": "override-wh"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body || $input.first().json;\nreturn [{ json: {\n  leadId: body.leadId,\n  overrideReason: body.overrideReason || ''\n}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6784,
        640
      ],
      "id": "d31c6e2e-e52a-4795-8c44-f1e4fda8e265",
      "name": "Parse Override"
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "={leadId}='{{ $json.leadId }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        7024,
        640
      ],
      "id": "90f02da9-4f83-4758-9ae4-4a3b02cd8795",
      "name": "Find Lead (Override)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const ovr = $('Parse Override').first().json;\nconst record = $('Find Lead (Override)').first().json;\nif (!record || !record.id) throw new Error('Lead not found: ' + ovr.leadId);\nreturn [{ json: {\n  id: record.id,\n  status: 'PENDING_ENRICHMENT',\n  overrideReason: ovr.overrideReason,\n  disqualificationReason: ''\n}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7264,
        640
      ],
      "id": "f66c0372-fc7c-4d7d-9f05-5cc9e761103d",
      "name": "Prep Override Update"
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.id }}",
            "status": "={{ $json.status }}",
            "overrideReason": "={{ $json.overrideReason }}",
            "disqualificationReason": ""
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        7504,
        640
      ],
      "id": "e6509e1a-bad0-40d8-8a7f-c5d069460fcc",
      "name": "Update Lead (Override)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, leadId: $('Parse Override').first().json.leadId, status: 'PENDING_ENRICHMENT' }) }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        7744,
        640
      ],
      "id": "9b0f046f-e3c0-4e23-a846-3ade0d29368f",
      "name": "Return 200 (Override)"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/leads/request-info",
        "responseMode": "responseNode",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        6544,
        928
      ],
      "id": "a3eb511a-b21b-443e-a714-93c64312839b",
      "name": "POST /api/leads/request-info",
      "webhookId": "info-wh"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body || $input.first().json;\nreturn [{ json: {\n  leadId: body.leadId,\n  followUpQuestion: body.followUpQuestion || ''\n}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6784,
        928
      ],
      "id": "1fce9aa7-6674-456a-a36d-ee340077a53d",
      "name": "Parse Info Request"
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "={leadId}='{{ $json.leadId }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        7024,
        928
      ],
      "id": "431e7fc2-d377-4e13-9ed6-49f3463590e8",
      "name": "Find Lead (Info)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const info = $('Parse Info Request').first().json;\nconst record = $('Find Lead (Info)').first().json;\nif (!record || !record.id) throw new Error('Lead not found: ' + info.leadId);\nreturn [{ json: {\n  id: record.id,\n  status: 'AWAITING_INFO'\n}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7264,
        928
      ],
      "id": "c69b18d1-b5b3-4108-8a06-179af661d522",
      "name": "Prep Info Update"
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.id }}",
            "status": "={{ $json.status }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        7504,
        928
      ],
      "id": "94225889-6cb8-4f4a-9103-af7fc68cca58",
      "name": "Update Lead (Info)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, leadId: $('Parse Info Request').first().json.leadId, status: 'AWAITING_INFO' }) }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        7744,
        928
      ],
      "id": "3796fa5f-7c66-45c3-91f8-7820eb925862",
      "name": "Return 200 (Info)"
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "gWXc9hPm86WTrwK0",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "leadId": "={{ $('Process Approval').first().json.leadId }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "leadId",
              "displayName": "leadId",
              "type": "string"
            }
          ]
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "5dfbf2e6-450c-4b07-8179-f17593fc50f5",
      "name": "Trigger WF5 - Outreach",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        7744,
        -80
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "F4ZRJbdHVKvYnh5v",
          "mode": "list",
          "cachedResultUrl": "/workflow/F4ZRJbdHVKvYnh5v",
          "cachedResultName": "WF8 - Rejection Email Generation"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "leadId": "={{ $('Parse Reject').first().json.leadId }}",
            "rejectionReason": "={{ $('Parse Reject').first().json.rejectionReason || 'not_a_fit' }}",
            "customNote": "={{ $('Parse Reject').first().json.customNote || 'Rejected by admin via dashboard' }}"
          },
          "matchingColumns": [
            "leadId"
          ],
          "schema": [
            {
              "id": "leadId",
              "displayName": "leadId",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "rejectionReason",
              "displayName": "rejectionReason",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            },
            {
              "id": "customNote",
              "displayName": "customNote",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string"
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "3146cb13-48ee-42c1-aacf-84ad2b454a47",
      "name": "Trigger WF8 - Rejection Email",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        7744,
        448
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "HfZqG2gp6J25webY",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "leadId": "={{ $('Parse Override').first().json.leadId }}"
          },
          "matchingColumns": [
            "leadId"
          ],
          "schema": [
            {
              "id": "leadId",
              "displayName": "leadId",
              "type": "string"
            }
          ]
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "c85b3467-a635-4f05-bf03-ba624f7ac419",
      "name": "Trigger WF2 - Enrich Override",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        7744,
        752
      ]
    },
    {
      "parameters": {
        "path": "api/leads/disqualified",
        "responseMode": "responseNode",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "id": "9af98996-3fa2-40b7-b515-745ef169be38",
      "name": "GET /api/leads/disqualified",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        6544,
        1232
      ],
      "webhookId": "ee52d33d-5093-4a84-b3ad-e8e8f78c028e"
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "{status}='DISQUALIFIED'",
        "options": {}
      },
      "id": "edf76f94-8efa-4c25-883c-291f52541f9d",
      "name": "Fetch DQ Leads",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        6784,
        1232
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const leads = $input.all().map(i => i.json);\nconst now = new Date();\n\nconst formatted = leads.map(lead => {\n  const submitted = new Date(lead.submittedAt);\n  const hoursElapsed = (now - submitted) / (1000 * 60 * 60);\n  const graceHoursRemaining = Math.max(0, 48 - hoursElapsed);\n  const gracePeriodExpired = hoursElapsed >= 48;\n\n  // Parse disqualification reasons into human-readable labels\n  const reasonMap = {\n    'jurisdiction_not_served': 'Jurisdiction not served',\n    'below_asset_threshold': 'Below asset threshold',\n    'goal_mismatch': 'Service goals not offered'\n  };\n  const rawReasons = (lead.disqualificationReason || '').split(',').filter(Boolean);\n  const readableReasons = rawReasons.map(r => reasonMap[r.trim()] || r.trim());\n\n  // Asset range display\n  const assetDisplay = {\n    'under_25k': 'Under $25K',\n    '25k_100k': '$25K - $100K',\n    '100k_250k': '$100K - $250K',\n    '250k_500k': '$250K - $500K',\n    '500k_1m': '$500K - $1M',\n    '1m_plus': '$1M+'\n  };\n\n  const incomeDisplay = {\n    'under_50k': 'Under $50K',\n    '50k_100k': '$50K - $100K',\n    '100k_200k': '$100K - $200K',\n    '200k_plus': '$200K+'\n  };\n\n  return {\n    id: lead.id,\n    leadId: lead.leadId,\n    fullName: lead.fullName,\n    email: lead.email,\n    phone: lead.phone || '',\n    province: lead.province,\n    investableAssets: lead.investableAssets,\n    investableAssetsDisplay: assetDisplay[lead.investableAssets] || lead.investableAssets,\n    annualIncome: lead.annualIncome,\n    annualIncomeDisplay: incomeDisplay[lead.annualIncome] || lead.annualIncome,\n    financialGoals: lead.financialGoals,\n    investmentTimeline: lead.investmentTimeline,\n    riskTolerance: lead.riskTolerance,\n    currentAdvisorSituation: lead.currentAdvisorSituation,\n    preferredDate: lead.preferredDate,\n    preferredTime: lead.preferredTime,\n    backupDate: lead.backupDate || '',\n    backupTime: lead.backupTime || '',\n    freeText: lead.freeText || '',\n    submittedAt: lead.submittedAt,\n    disqualificationReasons: rawReasons,\n    disqualificationReasonsDisplay: readableReasons,\n    graceHoursRemaining: Math.round(graceHoursRemaining * 10) / 10,\n    gracePeriodExpired,\n    rejectionEmailSentAt: lead.rejectionEmailSentAt || null,\n    status: lead.status\n  };\n});\n\n// Sort: grace period active first (most urgent), then by submission time\nformatted.sort((a, b) => {\n  if (a.gracePeriodExpired !== b.gracePeriodExpired) return a.gracePeriodExpired ? 1 : -1;\n  return a.graceHoursRemaining - b.graceHoursRemaining;\n});\n\nreturn [{ json: { leads: formatted, count: formatted.length } }];"
      },
      "id": "c94cd763-aa53-452a-9f38-2d6731a5ddad",
      "name": "Format DQ Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        7024,
        1232
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "98e79017-0cdb-4a37-a0bb-ae86061a3266",
      "name": "Return DQ Leads",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        7264,
        1232
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/leads/confirm-reject",
        "responseMode": "responseNode",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "id": "40decb51-e380-4fb1-9013-28e0a470e02e",
      "name": "POST /api/leads/confirm-reject",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        6544,
        1536
      ],
      "webhookId": "1c4861f4-8942-49e6-81bd-ff6432a9f1f6"
    },
    {
      "parameters": {
        "jsCode": "const body = $input.first().json.body || $input.first().json;\nreturn [{ json: {\n  leadId: body.leadId,\n  rejectionReason: body.rejectionReason || 'not_a_fit',\n  customNote: body.customNote || 'Admin confirmed rejection from auto-rejected view',\n  confirmedAt: new Date().toISOString()\n}}];"
      },
      "id": "a4943500-060f-4cf0-9d1a-557bc9da2411",
      "name": "Parse Confirm Reject",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6784,
        1536
      ]
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "={leadId}='{{ $json.leadId }}'",
        "options": {}
      },
      "id": "a87a1c19-c434-42c4-9ad0-31c1901bdf72",
      "name": "Find Lead (Confirm Reject)",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        7024,
        1536
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('Find Lead (Confirm Reject)').first().json.id }}",
            "status": "REJECTED",
            "rejectionReason": "={{ $('Parse Confirm Reject').first().json.rejectionReason }}",
            "rejectedAt": "={{ $('Parse Confirm Reject').first().json.confirmedAt }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "150214f7-29de-4774-a1cd-44f8f9422850",
      "name": "Update Lead (Confirm Reject)",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        7264,
        1536
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "F4ZRJbdHVKvYnh5v",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "leadId": "={{ $('Parse Confirm Reject').first().json.leadId }}",
            "rejectionReason": "={{ $('Parse Confirm Reject').first().json.rejectionReason }}",
            "customNote": "={{ $('Parse Confirm Reject').first().json.customNote }}"
          },
          "matchingColumns": [
            "leadId"
          ],
          "schema": [
            {
              "id": "leadId",
              "displayName": "leadId",
              "type": "string"
            },
            {
              "id": "rejectionReason",
              "displayName": "rejectionReason",
              "type": "string"
            },
            {
              "id": "customNote",
              "displayName": "customNote",
              "type": "string"
            }
          ]
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "1f1278a0-daf2-4f67-b087-430a22e6a977",
      "name": "Trigger WF8 - Confirmed Rejection",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        7504,
        1648
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, leadId: $('Parse Confirm Reject').first().json.leadId, status: 'REJECTED', message: 'Rejection confirmed, email will be sent.' }) }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              }
            ]
          }
        }
      },
      "id": "2c534b75-823e-4040-a5f7-7733be3cebd0",
      "name": "Return 200 (Confirm Reject)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        7504,
        1472
      ]
    },
    {
      "parameters": {
        "content": "# WF5: EMAIL OUTREACH & BOOKING\n\n**Trigger:** Called from WF4 after admin approves lead\n\n**Flow:**\n1. Get lead from Airtable (has all enrichment + availability data)\n2. **REAL-TIME ADVISOR CROSS-CHECK** in Prep Lead Data:\n   - If admin's chosen advisor MATCHES the suggestedBooking advisor → trust WF3's pre-check\n   - If admin chose a DIFFERENT advisor → default to SCHEDULING_REQUIRED (safe fallback)\n3. IF isTimeAvailable = true:\n   → Send confirmation email + log appointment + mark BOOKED → WF10 → WF11\n4. IF isTimeAvailable = false:\n   → Send scheduling outreach email + mark OUTREACH_IN_PROGRESS\n\n**Why the cross-check:** WF3 checks availability for the AI's top-ranked advisor during enrichment. But the admin may override to a different advisor at approval time. We can't trust WF3's result if the advisor changed.",
        "height": 1200,
        "width": 2320,
        "color": 7
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        8320,
        -32
      ],
      "id": "3445d598-3b50-4798-bb26-8d029f9499c3",
      "name": "WF5 Overview"
    },
    {
      "parameters": {
        "jsCode": "const lead = $input.first().json;\nlet suggestedBooking = null;\ntry { suggestedBooking = typeof lead.suggestedBooking === 'string' && lead.suggestedBooking ? JSON.parse(lead.suggestedBooking) : lead.suggestedBooking; } catch(e) {}\nlet starters = [];\ntry { starters = typeof lead.conversationStarters === 'string' ? JSON.parse(lead.conversationStarters) : (lead.conversationStarters || []); } catch(e) {}\nlet docsToRequest = [];\ntry { docsToRequest = typeof lead.documentsToRequest === 'string' ? JSON.parse(lead.documentsToRequest) : (lead.documentsToRequest || []); } catch(e) {\n  docsToRequest = [\"Recent bank statements (all accounts)\", \"Most recent Notice of Assessment (NOA) from CRA\", \"Previous year tax return\"];\n}\nif (!docsToRequest || docsToRequest.length === 0) {\n  docsToRequest = [\"Recent bank statements (all accounts)\", \"Most recent Notice of Assessment (NOA) from CRA\", \"Previous year tax return\"];\n}\n\n// Resolve advisor name if missing\nlet advisorName = lead.assignedAdvisorName || '';\nconst advisorId = lead.assignedAdvisorId || '';\nif (advisorId && !advisorName) {\n  try {\n    const ranking = typeof lead.advisorMatchRanking === 'string' ? JSON.parse(lead.advisorMatchRanking) : (lead.advisorMatchRanking || []);\n    const match = ranking.find(a => a.advisorId === advisorId);\n    if (match) advisorName = match.advisorName;\n  } catch(e) {}\n}\nif (advisorId && !advisorName) {\n  const advisorMap = { ADV001: 'Michael Torres', ADV002: 'Priya Sharma', ADV003: 'David Kim', ADV004: 'Rachel Nguyen' };\n  advisorName = advisorMap[advisorId] || '';\n}\n\n// REAL-TIME AVAILABILITY CHECK\n// Instead of trusting pre-computed availabilityStatus (which was checked against\n// the AI's top-ranked advisor, not necessarily the admin's chosen advisor),\n// we re-check availability for the ACTUALLY assigned advisor right now.\nlet isTimeAvailable = false;\nlet resolvedAvailabilityStatus = 'SCHEDULING_REQUIRED';\nlet resolvedBooking = suggestedBooking;\n\ntry {\n  // Get availability data from Redis cache\n  const availCache = await this.helpers.httpRequest({\n    method: 'GET',\n    url: 'http://localhost:6379',\n    // Can't call Redis directly from Code node - use the pre-computed value\n    // BUT cross-check: if the assigned advisor matches the suggestedBooking advisor, trust it\n  });\n} catch(e) {\n  // Expected - we can't call Redis from a Code node\n}\n\n// Smart cross-check logic:\n// If suggestedBooking exists AND its advisorId matches the assigned advisor,\n// then the WF3 availability check IS valid for this advisor\nif (suggestedBooking && suggestedBooking.advisorId === advisorId) {\n  // WF3 checked this exact advisor - trust the pre-computed status\n  isTimeAvailable = (lead.availabilityStatus === 'PREFERRED_AVAILABLE' || lead.availabilityStatus === 'BACKUP_AVAILABLE');\n  resolvedAvailabilityStatus = lead.availabilityStatus || 'SCHEDULING_REQUIRED';\n} else if (!advisorId) {\n  // No advisor assigned (shouldn't happen post-approval, but safety)\n  isTimeAvailable = false;\n  resolvedAvailabilityStatus = 'SCHEDULING_REQUIRED';\n} else {\n  // MISMATCH: Admin chose a different advisor than WF3 checked.\n  // We CANNOT trust the pre-computed availabilityStatus.\n  // Default to SCHEDULING_REQUIRED to be safe - the outreach email\n  // will offer time slots and the client can pick one.\n  isTimeAvailable = false;\n  resolvedAvailabilityStatus = 'SCHEDULING_REQUIRED';\n  resolvedBooking = null; // Clear stale booking suggestion\n}\n\nreturn [{ json: {\n  airtableRecordId: lead.id,\n  leadId: lead.leadId,\n  fullName: lead.fullName,\n  email: lead.email,\n  assignedAdvisorId: advisorId,\n  assignedAdvisorName: advisorName,\n  availabilityStatus: resolvedAvailabilityStatus,\n  suggestedBooking: resolvedBooking,\n  preferredDate: lead.preferredDate || '',\n  preferredTime: lead.preferredTime || '',\n  conversationStarters: starters,\n  documentsToRequest: docsToRequest,\n  isTimeAvailable: isTimeAvailable\n}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        8880,
        544
      ],
      "id": "932d14dd-c580-4d3b-88ea-eb251848d053",
      "name": "Prep Lead Data"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "avail-check",
              "leftValue": "={{ $json.isTimeAvailable }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        9120,
        544
      ],
      "id": "3dd6210d-d1c2-4b6f-85a2-0e57e0140ce5",
      "name": "Time Available?"
    },
    {
      "parameters": {
        "jsCode": "const lead = $('Prep Lead Data').first().json;\nconst booking = lead.suggestedBooking || {};\nconst advisorName = lead.assignedAdvisorName || 'your assigned advisor';\nconst bookingDate = booking.date || lead.preferredDate;\nconst bookingTime = booking.time || lead.preferredTime;\nlet dateStr = bookingDate;\ntry { const d = new Date(bookingDate + 'T12:00:00'); dateStr = d.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); } catch(e) {}\nlet timeStr = bookingTime;\ntry { const [h, m] = bookingTime.split(':'); const hr = parseInt(h); timeStr = (hr > 12 ? (hr-12) : hr) + ':' + m + (hr >= 12 ? ' PM' : ' AM'); } catch(e) {}\nconst firstName = lead.fullName.split(' ')[0];\n\n// Build documents to request section\nconst docs = lead.documentsToRequest || ['Recent bank statements (all accounts)', 'Most recent Notice of Assessment (NOA) from CRA', 'Previous year\\'s tax return'];\nconst docsHtml = docs.map(d => `<li style=\"padding: 4px 0;\">${d}</li>`).join('');\n\nconst subject = `Your consultation with ${advisorName} is confirmed — ${dateStr}`;\nconst body = `<div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; color: #1a1a2e;\">\n<div style=\"background: #0a2540; padding: 32px 40px; border-radius: 12px 12px 0 0;\">\n<h1 style=\"color: #ffffff; font-size: 22px; font-weight: 600; margin: 0;\">Consultation Confirmed &#10003;</h1>\n</div>\n<div style=\"background: #ffffff; padding: 32px 40px; border: 1px solid #e8e8e8; border-top: none;\">\n<p style=\"font-size: 16px; line-height: 1.6; margin-top: 0;\">Dear ${firstName},</p>\n<p style=\"font-size: 16px; line-height: 1.6;\">Great news — your consultation with NorthStar Wealth Advisory has been confirmed.</p>\n\n<div style=\"background: #f8f9fb; border-left: 4px solid #0a2540; padding: 20px 24px; border-radius: 0 8px 8px 0; margin: 24px 0;\">\n<h2 style=\"font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; margin: 0 0 12px 0;\">Consultation Details</h2>\n<table style=\"width: 100%; border-collapse: collapse;\">\n<tr><td style=\"padding: 6px 0; font-size: 15px; color: #6b7280; width: 100px;\">Advisor</td><td style=\"padding: 6px 0; font-size: 15px; font-weight: 600;\">${advisorName}</td></tr>\n<tr><td style=\"padding: 6px 0; font-size: 15px; color: #6b7280;\">Date</td><td style=\"padding: 6px 0; font-size: 15px; font-weight: 600;\">${dateStr}</td></tr>\n<tr><td style=\"padding: 6px 0; font-size: 15px; color: #6b7280;\">Time</td><td style=\"padding: 6px 0; font-size: 15px; font-weight: 600;\">${timeStr} ET</td></tr>\n<tr><td style=\"padding: 6px 0; font-size: 15px; color: #6b7280;\">Duration</td><td style=\"padding: 6px 0; font-size: 15px; font-weight: 600;\">60 minutes</td></tr>\n<tr><td style=\"padding: 6px 0; font-size: 15px; color: #6b7280;\">Format</td><td style=\"padding: 6px 0; font-size: 15px; font-weight: 600;\">Video call (link sent 24h before)</td></tr>\n</table>\n</div>\n\n<div style=\"background: #f0fdf4; border: 1px solid #bbf7d0; padding: 20px 24px; border-radius: 8px; margin: 24px 0;\">\n<h3 style=\"font-size: 15px; color: #166534; margin: 0 0 12px 0;\">📋 Documents to Prepare</h3>\n<p style=\"font-size: 14px; color: #166534; margin: 0 0 8px 0;\">To make the most of your consultation, please have the following ready:</p>\n<ul style=\"margin: 0; padding-left: 20px; color: #1a1a2e; font-size: 14px; line-height: 1.8; list-style-type: disc;\">\n${docsHtml}\n</ul>\n<p style=\"font-size: 13px; color: #6b7280; margin: 12px 0 0 0; font-style: italic;\">If you don't have all of these, that's okay — bring what you can and we'll work with what's available.</p>\n</div>\n\n<p style=\"font-size: 14px; line-height: 1.6; color: #6b7280;\">Need to reschedule or cancel? Simply reply to this email.</p>\n<p style=\"font-size: 16px; line-height: 1.6;\">We look forward to speaking with you!</p>\n<p style=\"font-size: 15px; line-height: 1.6; margin-bottom: 0;\">Best regards,<br><strong>NorthStar Wealth Advisory Team</strong></p>\n</div>\n<div style=\"padding: 20px 40px; text-align: center; font-size: 12px; color: #9ca3af;\">NorthStar Wealth Advisory · Toronto, ON<br>This email was sent regarding your consultation request.</div>\n</div>`;\nreturn [{ json: { ...lead, emailSubject: subject, emailBody: body, bookingDate, bookingTime } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9360,
        448
      ],
      "id": "55a66837-e679-4ee6-919e-6c457b8666d6",
      "name": "Build Confirmation Email"
    },
    {
      "parameters": {
        "sendTo": "={{ $json.email }}",
        "subject": "={{ $json.emailSubject }}",
        "message": "={{ $json.emailBody }}",
        "options": {
          "senderName": "NorthStar Wealth Advisory"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        9600,
        448
      ],
      "id": "78f6f797-d7a1-4491-8ef3-05eb2267db4b",
      "name": "Send Confirmation Email",
      "webhookId": "ad90a522-4fa7-4f47-b57b-b8fed08fecc1",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const lead = $('Prep Lead Data').first().json;\nconst now = new Date().toISOString();\nreturn [{ json: { airtableRecordId: lead.airtableRecordId, leadId: lead.leadId, bookedAt: now, appointmentDatetime: (lead.suggestedBooking ? lead.suggestedBooking.date + 'T' + lead.suggestedBooking.time + ':00' : lead.preferredDate + 'T' + lead.preferredTime + ':00') } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9840,
        448
      ],
      "id": "75dab5aa-6c5c-4815-80ba-d2d299cbc4a0",
      "name": "Log Appointment"
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.airtableRecordId }}",
            "status": "BOOKED",
            "bookedAt": "={{ $json.bookedAt }}",
            "appointmentDatetime": "={{ $json.appointmentDatetime }}",
            "assignedAdvisorName": "={{ $('Prep Lead Data').first().json.assignedAdvisorName }}",
            "emailThreadId": "={{ $('Send Confirmation Email').first().json.threadId }}",
            "lastEmailSentAt": "={{ new Date().toISOString() }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        10080,
        448
      ],
      "id": "b521e62c-de58-438d-be22-5192445a8d9d",
      "name": "Update Lead BOOKED",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const lead = $('Prep Lead Data').first().json;\nconst advisorName = lead.assignedAdvisorName || 'your assigned advisor';\nconst firstName = lead.fullName.split(' ')[0];\nconst slots = [];\nconst baseDate = new Date();\nfor (let i = 1; i <= 7 && slots.length < 4; i++) {\n  const d = new Date(baseDate);\n  d.setDate(d.getDate() + i);\n  if (d.getDay() === 0 || d.getDay() === 6) continue;\n  const dateStr = d.toISOString().split('T')[0];\n  const friendlyDate = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });\n  if (slots.length < 2) slots.push({ date: dateStr, time: '10:00', label: `${friendlyDate} at 10:00 AM ET` });\n  else slots.push({ date: dateStr, time: '14:00', label: `${friendlyDate} at 2:00 PM ET` });\n}\nconst slotRows = slots.map((s, i) => `<tr><td style=\"padding: 12px 16px; font-size: 15px; font-weight: 600; color: #0a2540; border-bottom: 1px solid #f0f0f0; width: 90px;\">Option ${i+1}</td><td style=\"padding: 12px 16px; font-size: 15px; border-bottom: 1px solid #f0f0f0;\">${s.label}</td></tr>`).join('');\n\n// Build documents to request section\nconst docs = lead.documentsToRequest || ['Recent bank statements (all accounts)', 'Most recent Notice of Assessment (NOA) from CRA', 'Previous year\\'s tax return'];\nconst docsHtml = docs.map(d => `<li style=\"padding: 4px 0;\">${d}</li>`).join('');\n\nconst subject = `Schedule your consultation with ${advisorName} — NorthStar Wealth Advisory`;\nconst body = `<div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; color: #1a1a2e;\">\n<div style=\"background: #0a2540; padding: 32px 40px; border-radius: 12px 12px 0 0;\">\n<h1 style=\"color: #ffffff; font-size: 22px; font-weight: 600; margin: 0;\">Let's Schedule Your Consultation</h1>\n</div>\n<div style=\"background: #ffffff; padding: 32px 40px; border: 1px solid #e8e8e8; border-top: none;\">\n<p style=\"font-size: 16px; line-height: 1.6; margin-top: 0;\">Dear ${firstName},</p>\n<p style=\"font-size: 16px; line-height: 1.6;\">Thank you for your interest in NorthStar Wealth Advisory! Your application has been approved and we'd love to set up your initial consultation with <strong>${advisorName}</strong>.</p>\n<p style=\"font-size: 16px; line-height: 1.6;\">Unfortunately, your preferred time isn't available. Here are some alternative options:</p>\n\n<div style=\"border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden; margin: 24px 0;\">\n<table style=\"width: 100%; border-collapse: collapse;\">\n<thead><tr style=\"background: #f8f9fb;\"><th style=\"padding: 10px 16px; text-align: left; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; border-bottom: 1px solid #e5e7eb;\"></th><th style=\"padding: 10px 16px; text-align: left; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: #6b7280; border-bottom: 1px solid #e5e7eb;\">Date &amp; Time</th></tr></thead>\n<tbody>${slotRows}</tbody>\n</table>\n</div>\n\n<div style=\"background: #eff6ff; border: 1px solid #bfdbfe; padding: 16px 20px; border-radius: 8px; margin: 24px 0;\">\n<p style=\"margin: 0; font-size: 14px; color: #1e40af;\"><strong>How to reply:</strong> Simply respond with your preferred option number (e.g., \"Option 1\") or suggest a different time that works for you.</p>\n</div>\n\n<div style=\"background: #f0fdf4; border: 1px solid #bbf7d0; padding: 20px 24px; border-radius: 8px; margin: 24px 0;\">\n<h3 style=\"font-size: 15px; color: #166534; margin: 0 0 12px 0;\">📋 Documents to Prepare</h3>\n<p style=\"font-size: 14px; color: #166534; margin: 0 0 8px 0;\">While we finalize your appointment, you can start gathering these documents:</p>\n<ul style=\"margin: 0; padding-left: 20px; color: #1a1a2e; font-size: 14px; line-height: 1.8; list-style-type: disc;\">\n${docsHtml}\n</ul>\n<p style=\"font-size: 13px; color: #6b7280; margin: 12px 0 0 0; font-style: italic;\">If you don't have all of these, that's okay — bring what you can and we'll work with what's available.</p>\n</div>\n\n<p style=\"font-size: 14px; line-height: 1.6; color: #6b7280;\">Our consultation hours are <strong>Monday–Friday, 9:00 AM – 5:00 PM Eastern Time</strong>.</p>\n<p style=\"font-size: 16px; line-height: 1.6;\">We look forward to hearing from you!</p>\n<p style=\"font-size: 15px; line-height: 1.6; margin-bottom: 0;\">Best regards,<br><strong>NorthStar Wealth Advisory Team</strong></p>\n</div>\n<div style=\"padding: 20px 40px; text-align: center; font-size: 12px; color: #9ca3af;\">NorthStar Wealth Advisory · Toronto, ON<br>This email was sent regarding your consultation request.</div>\n</div>`;\nreturn [{ json: { ...lead, emailSubject: subject, emailBody: body, alternativeSlots: JSON.stringify(slots) } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        9360,
        672
      ],
      "id": "d3c99933-242f-4528-bfa0-0f3d189efe61",
      "name": "Build Scheduling Outreach"
    },
    {
      "parameters": {
        "sendTo": "={{ $json.email }}",
        "subject": "={{ $json.emailSubject }}",
        "message": "={{ $json.emailBody }}",
        "options": {
          "senderName": "NorthStar Wealth Advisory"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        9600,
        672
      ],
      "id": "9d054c1a-79ce-4b57-8b1e-4a8aa9cd6aac",
      "name": "Send Outreach Email",
      "webhookId": "d44c1020-f9a7-44bb-ae79-d13d003cb820",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('Prep Lead Data').first().json.airtableRecordId }}",
            "status": "OUTREACH_IN_PROGRESS",
            "lastEmailSentAt": "={{ new Date().toISOString() }}",
            "emailThreadId": "={{ $json.threadId }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        9840,
        672
      ],
      "id": "1a044523-8298-46a3-a1a7-d4de60ec2d5e",
      "name": "Update Lead OUTREACH",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "smuharsk@gmail.com",
        "subject": "=WF5 Error: {{ $json.workflow?.name || 'Email Outreach' }}",
        "message": "=WF5 Error Alert\\n\\nError: {{ $json.execution?.error?.message || JSON.stringify($json) }}\\nTime: {{ new Date().toISOString() }}",
        "options": {
          "senderName": "NorthStar Pipeline Alerts"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        9120,
        848
      ],
      "id": "5ee2aa62-fdab-4588-9a2c-b0a1fc61cd1b",
      "name": "Send WF5 Error Alert",
      "webhookId": "475fed4d-bd6a-47df-8264-3ff604d4f107",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "JlBlolawHoZv1ylN",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "leadId": "={{ $('Prep Lead Data').first().json.leadId }}",
            "source": "wf5_booking"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "leadId",
              "displayName": "leadId",
              "type": "string"
            },
            {
              "id": "source",
              "displayName": "source",
              "type": "string"
            }
          ]
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "92f5894d-46cf-4eef-9309-6eb44e99a8d3",
      "name": "Trigger WF10 - Prep Brief",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        10320,
        448
      ]
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "={leadId}='{{ $json.leadId }}'",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        8640,
        544
      ],
      "id": "6d544b93-b3d0-4ae2-9b74-1166239b2df2",
      "name": "Get Lead from Airtable1",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "content": "# WF6: INBOUND EMAIL PROCESSING\n\n**Trigger:** Gmail trigger polls for new unread emails matching NorthStar threads\n\n**Flow:**\n1. Match sender email to lead in Airtable\n2. Verify lead is in OUTREACH_IN_PROGRESS status\n3. AI Email Reply Parser classifies intent:\n   - selected → book the chosen slot\n   - suggest_alternative → check that time\n   - cancel → mark cancelled\n   - question → answer and re-prompt\n   - unclear → ask for clarification\n4. Execute appropriate action",
        "height": 944,
        "width": 3592,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        10640,
        96
      ],
      "id": "9ec442be-2ab7-4fb8-9e29-7032d711f1b4",
      "name": "WF6 Overview"
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "filters": {
          "q": "to:smuharsk@gmail.com subject:(NorthStar Wealth Advisory) -from:smuharsk@gmail.com",
          "readStatus": "unread"
        }
      },
      "type": "n8n-nodes-base.gmailTrigger",
      "typeVersion": 1.3,
      "position": [
        10848,
        496
      ],
      "id": "8077ee8a-da1a-49b6-9b81-202875cfeaa4",
      "name": "Gmail Trigger - New Replies",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "={{ '{email}=\"' + ($json.from?.value?.[0]?.address || $json.from || '') + '\"' }}",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        11088,
        496
      ],
      "id": "becd954a-050d-44f7-8513-dede96627025",
      "name": "Match Email to Lead (Airtable)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-lead",
              "leftValue": "={{ $json.leadId }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        11328,
        496
      ],
      "id": "db1a2d1c-17ec-4552-9e80-97befe1fca4f",
      "name": "Lead Found?"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "status-check",
              "leftValue": "={{ $json.status }}",
              "rightValue": "OUTREACH_IN_PROGRESS",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        11568,
        496
      ],
      "id": "2c5e510e-d3b5-4530-8fad-e9dfa9fbb6f7",
      "name": "In Outreach?"
    },
    {
      "parameters": {
        "jsCode": "const lead = $('Match Email to Lead (Airtable)').first().json;\nconst emailBody = $('Gmail Trigger - New Replies').first().json.text || $('Gmail Trigger - New Replies').first().json.snippet || '';\n\nlet pendingSlots = [];\ntry { pendingSlots = JSON.parse(lead.pendingSlots || '[]'); } catch(e) {}\n\nreturn [{ json: {\n  leadId: lead.leadId,\n  email: lead.email,\n  fullName: lead.fullName,\n  assignedAdvisorId: lead.assignedAdvisorId,\n  assignedAdvisorName: lead.assignedAdvisorName,\n  emailBody,\n  pendingSlots\n} }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        11808,
        496
      ],
      "id": "2bc7c6e3-3255-4fd3-9ba6-a4d68e27cf0d",
      "name": "Prep Parser Context"
    },
    {
      "parameters": {
        "text": "=Client's email reply:\n{{ $json.emailBody }}\n\nPending slots offered:\n{{ JSON.stringify($json.pendingSlots) }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You classify email replies from prospective clients who were offered consultation time slots.\n\n## CONTEXT\n- Client was sent an email with numbered available time slots\n- pendingSlots: JSON array of offered datetimes\n- Client's reply needs classification\n\n## OUTPUT FORMAT\n{\"action\": \"selected\" | \"suggest_alternative\" | \"cancel\" | \"question\" | \"unclear\", \"selectedSlotIndex\": number | null, \"suggestedDatetime\": \"YYYY-MM-DD HH:MM\" | null, \"extractedQuestion\": \"string\" | null}\n\n## RULES\n- selected: Client chose offered slot. Set selectedSlotIndex (0-based).\n- suggest_alternative: Client proposes different time\n- cancel: Client says never mind, not interested, cancel\n- question: Client asks a question before scheduling\n- unclear: Can't determine intent\n- Cancel keywords always win. Output ONLY valid JSON"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        12048,
        496
      ],
      "id": "88689177-c56a-4df8-b720-1f2e7ac6b4e0",
      "name": "Email Reply Parser"
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        12048,
        720
      ],
      "id": "83f58cfe-8629-498b-9da6-1454ab691579",
      "name": "Gemini (Parser)",
      "credentials": {
        "googlePalmApi": {
          "id": "gKOxHvioCsyTdrwX",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{ \"type\": \"object\", \"properties\": { \"action\": { \"type\": \"string\", \"enum\": [\"selected\", \"suggest_alternative\", \"cancel\", \"question\", \"unclear\"] }, \"selectedSlotIndex\": { \"type\": [\"integer\", \"null\"] }, \"suggestedDatetime\": { \"type\": [\"string\", \"null\"] }, \"extractedQuestion\": { \"type\": [\"string\", \"null\"] } }, \"required\": [\"action\"] }"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        12192,
        720
      ],
      "id": "8676f7aa-d737-41f4-9c47-1363ef9ad024",
      "name": "Reply Parser Schema"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "selected",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "cancel",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "question",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "unclear",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        12368,
        432
      ],
      "id": "366c82bb-0ff7-4e0a-a1c2-002d9581c0c9",
      "name": "Route by Action"
    },
    {
      "parameters": {
        "jsCode": "const parsed = $('Email Reply Parser').first().json;\nconst context = $('Prep Parser Context').first().json;\nconst idx = parsed.selectedSlotIndex || 0;\nconst slot = context.pendingSlots[idx];\nif (!slot) throw new Error(`Invalid slot index ${idx}`);\nreturn [{ json: {\n  leadId: context.leadId, email: context.email, fullName: context.fullName,\n  advisorId: context.assignedAdvisorId, advisorName: context.assignedAdvisorName,\n  bookingDate: slot.date, bookingTime: slot.time, bookingDisplay: slot.label\n} }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12608,
        336
      ],
      "id": "69ca776a-941f-4478-adbb-6c5d7d0ea06b",
      "name": "Prep Selected Booking"
    },
    {
      "parameters": {
        "sendTo": "={{ $json.email }}",
        "subject": "Your consultation is confirmed - NorthStar Wealth Advisory",
        "message": "={{ $json.emailBody }}",
        "options": {
          "senderName": "NorthStar Wealth Advisory"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        12880,
        336
      ],
      "id": "1d010dd7-6435-44ef-85d2-e15700a35b80",
      "name": "Send Booking Confirmation",
      "webhookId": "bfa4817d-ff8a-4e94-83fd-d1e85001fe2e",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=leadstate_{{ $('Prep Selected Booking').first().json.leadId }}",
        "value": "={{ JSON.stringify({ status: 'BOOKED', bookedAt: $now.toISO(), appointmentDatetime: $('Prep Selected Booking').first().json.bookingDate + 'T' + $('Prep Selected Booking').first().json.bookingTime + ':00' }) }}",
        "keyType": "hash"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        13168,
        336
      ],
      "id": "5aad7a8b-48b2-458f-8166-e15ed0224e6b",
      "name": "Set BOOKED",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "=FIND(\"{{ $('Prep Selected Booking').first().json.leadId }}\", {leadId})",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        13440,
        336
      ],
      "id": "b2719769-bbd4-4ef5-8a68-09406e3ffc84",
      "name": "Find Lead (Book Reply)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "status": "BOOKED",
            "bookedAt": "={{ $now.toISO() }}",
            "appointmentDatetime": "={{ $('Prep Selected Booking').first().json.bookingDate + 'T' + $('Prep Selected Booking').first().json.bookingTime + ':00' }}",
            "followUpCount": 0
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        13680,
        336
      ],
      "id": "caddf2db-e36e-4f33-9cef-e82cfd2d6936",
      "name": "Update Lead (BOOKED Reply)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const context = $('Prep Parser Context').first().json;\nreturn [{ json: { leadId: context.leadId, email: context.email, firstName: context.fullName.split(' ')[0] } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12608,
        496
      ],
      "id": "15518a56-bcf2-44ff-b74c-fb4318e78570",
      "name": "Prep Cancel"
    },
    {
      "parameters": {
        "sendTo": "={{ $json.email }}",
        "subject": "We understand - NorthStar Wealth Advisory",
        "message": "={{ $json.emailBody }}",
        "options": {
          "senderName": "NorthStar Wealth Advisory"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        12880,
        496
      ],
      "id": "c2929705-cb28-4efd-917d-46a761c687d9",
      "name": "Send Cancel Ack",
      "webhookId": "c5ba5583-8480-4bbf-ba08-f7edbf8c1fb7",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=leadstate_{{ $('Prep Cancel').first().json.leadId }}",
        "value": "={{ JSON.stringify({ status: 'CANCELLED_BY_LEAD', cancelledAt: $now.toISO() }) }}",
        "keyType": "hash"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        13168,
        496
      ],
      "id": "626038c9-f784-416f-b241-aa90f2006667",
      "name": "Set CANCELLED",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const context = $('Prep Parser Context').first().json;\nconst parsed = $('Email Reply Parser').first().json;\nconst firstName = context.fullName.split(' ')[0];\nlet msg;\nif (parsed.action === 'question') {\n  msg = `Hi ${firstName},\\n\\nGreat question! ${context.assignedAdvisorName} can address that during your consultation.\\n\\nIn the meantime, would any of the times I shared work for you? Just reply with your preferred option.\\n\\nBest,\\nNorthStar Wealth Advisory`;\n} else {\n  msg = `Hi ${firstName},\\n\\nThanks for your reply! I want to make sure I get this right - were you selecting one of the available times, or would you like to suggest a different time?\\n\\nJust reply with a number (1-4) to pick a slot, or suggest another time.\\n\\nBest,\\nNorthStar Wealth Advisory`;\n}\nreturn [{ json: { to: context.email, body: msg, leadId: context.leadId } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        12608,
        688
      ],
      "id": "487723d0-4f5c-47fe-9a06-25c4217c826a",
      "name": "Build Clarification"
    },
    {
      "parameters": {
        "sendTo": "={{ $json.to }}",
        "subject": "Re: Your consultation - NorthStar Wealth Advisory",
        "message": "={{ $json.body }}",
        "options": {
          "senderName": "NorthStar Wealth Advisory"
        }
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        12880,
        688
      ],
      "id": "db0a1a5f-b1b3-4871-9dd0-393955778882",
      "name": "Send Clarification",
      "webhookId": "29d7f36e-b2bd-4d86-b180-6eca0b6064f6",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=leadstate_{{ $('Build Clarification').first().json.leadId }}",
        "value": "={{ JSON.stringify({ lastEmailSentAt: $now.toISO() }) }}",
        "keyType": "hash"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        13168,
        688
      ],
      "id": "ccf21b18-a8b6-4d35-85fa-49163f775efe",
      "name": "Update lastEmailSentAt",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "workflowId": "JlBlolawHoZv1ylN",
        "mode": "each",
        "options": {}
      },
      "id": "129c974d-3af0-4cb5-ba3a-6e63f7fe75d4",
      "name": "Trigger WF10 - Prep Brief1",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1,
      "position": [
        13920,
        336
      ]
    },
    {
      "parameters": {
        "content": "# WF7: FOLLOW-UP CADENCE + DISQUALIFICATION GRACE PERIOD\n\n**Trigger:** Schedule — every 1 hour\n\n**Logic (OUTREACH_IN_PROGRESS):**\n- 48hrs no reply → Follow-up #1\n- 96hrs no reply → Follow-up #2\n- 168hrs (7d) no reply → Mark UNRESPONSIVE\n\n**Logic (DISQUALIFIED — 48h grace period):**\n- Auto-disqualified leads get 48h for admin review\n- If admin overrides → lead goes to PENDING_ENRICHMENT (no rejection email)\n- If 48h passes with no override → trigger WF8 rejection email\n\n**Max 2 follow-ups per outreach lead.**",
        "height": 1080,
        "width": 2400,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        14240,
        32
      ],
      "id": "52b2fa78-84cf-4ba7-bc6c-8d03817366d9",
      "name": "WF7 Overview"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        14496,
        448
      ],
      "id": "f1cb29f4-c7ed-4a65-baf8-d9baac1eded8",
      "name": "Every 1 Hour"
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "OR({status}='OUTREACH_IN_PROGRESS', AND({status}='DISQUALIFIED', {rejectionEmailSentAt}=''))",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        14736,
        448
      ],
      "id": "2dd28559-445f-4341-a16b-41530a038d4b",
      "name": "Fetch Actionable Leads (Airtable)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Determine which leads need follow-up action\n// Handles both OUTREACH_IN_PROGRESS follow-ups AND DISQUALIFIED 48h grace period\nconst allLeads = $input.all().map(i => i.json);\nconst now = new Date();\nconst results = [];\n\n// === OUTREACH_IN_PROGRESS leads: follow-up cadence ===\nconst outreachLeads = allLeads.filter(l => l.status === 'OUTREACH_IN_PROGRESS' && l.leadId && l.lastEmailSentAt);\nfor (const lead of outreachLeads) {\n  const lastEmail = new Date(lead.lastEmailSentAt);\n  const hoursElapsed = (now - lastEmail) / (1000 * 60 * 60);\n  const followUpCount = Number(lead.followUpCount) || 0;\n\n  let action = null;\n  if (hoursElapsed >= 168 && followUpCount >= 2) {\n    action = 'MARK_UNRESPONSIVE';\n  } else if (hoursElapsed >= 96 && followUpCount === 1) {\n    action = 'FOLLOWUP_2';\n  } else if (hoursElapsed >= 48 && followUpCount === 0) {\n    action = 'FOLLOWUP_1';\n  }\n\n  if (action) {\n    results.push({\n      leadId: lead.leadId,\n      email: lead.email,\n      fullName: lead.fullName,\n      firstName: (lead.fullName || '').split(' ')[0],\n      assignedAdvisorName: lead.assignedAdvisorName || 'our team',\n      followUpCount,\n      hoursElapsed: Math.round(hoursElapsed),\n      action\n    });\n  }\n}\n\n// === DISQUALIFIED leads: 48h grace period expired, send rejection email ===\nconst disqualifiedLeads = allLeads.filter(l => l.status === 'DISQUALIFIED' && l.leadId && l.submittedAt && !l.rejectionEmailSentAt);\nfor (const lead of disqualifiedLeads) {\n  const submitted = new Date(lead.submittedAt);\n  const hoursElapsed = (now - submitted) / (1000 * 60 * 60);\n\n  if (hoursElapsed >= 48) {\n    const reasons = lead.disqualificationReason || '';\n    let rejectionReason = 'other';\n    if (reasons.includes('jurisdiction')) rejectionReason = 'not_a_fit';\n    else if (reasons.includes('below_minimum')) rejectionReason = 'below_threshold_on_review';\n    else if (reasons.includes('goal_mismatch')) rejectionReason = 'not_a_fit';\n\n    results.push({\n      leadId: lead.leadId,\n      email: lead.email,\n      fullName: lead.fullName,\n      firstName: (lead.fullName || '').split(' ')[0],\n      disqualificationReasons: reasons,\n      rejectionReason,\n      hoursElapsed: Math.round(hoursElapsed),\n      action: 'SEND_DISQUALIFICATION_EMAIL'\n    });\n  }\n}\n\nif (results.length === 0) {\n  return [];\n}\n\nreturn results.map(r => ({ json: r }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        14976,
        448
      ],
      "id": "ec861108-7db5-4318-b0fb-b73f65b3c444",
      "name": "Determine Follow-Up Actions"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "FOLLOWUP_1",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "FOLLOWUP_2",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "MARK_UNRESPONSIVE",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            },
            {
              "conditions": {
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "SEND_DISQUALIFICATION_EMAIL",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ]
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        15216,
        448
      ],
      "id": "7632c366-c03d-40d6-802e-25a13100fba8",
      "name": "Route Action"
    },
    {
      "parameters": {
        "sendTo": "={{ $json.email }}",
        "subject": "Following up on your consultation — NorthStar Wealth Advisory",
        "message": "=Hi {{ $json.firstName }},\n\nJust checking in — would you still like to schedule a consultation with {{ $json.assignedAdvisorName }}? The times I shared are still available, or I'm happy to find new options.\n\nJust reply to this email and we'll get you set up.\n\nBest,\nNorthStar Wealth Advisory",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        15504,
        304
      ],
      "id": "e25c142f-b3b0-4397-8a50-bc3bdca26c6e",
      "name": "Send Follow-Up #1",
      "webhookId": "6a25ee05-985e-4aae-abb1-a3412d914102",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "={{ $json.email }}",
        "subject": "We'd love to connect when you're ready — NorthStar Wealth Advisory",
        "message": "=Hi {{ $json.firstName }},\n\nI wanted to reach out one more time. We'd love to connect you with {{ $json.assignedAdvisorName }} when you're ready.\n\nYou can reply to this email anytime, or if your situation has changed, no worries at all. We're here whenever you need us.\n\nWarm regards,\nNorthStar Wealth Advisory",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        15504,
        464
      ],
      "id": "06bb37ac-da5e-42dc-be1a-07a606e4dfa6",
      "name": "Send Follow-Up #2",
      "webhookId": "1c176d39-111c-4b16-a6cd-e135d58f523b",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "=FIND(\"{{ $json.leadId }}\", {leadId})",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        15776,
        304
      ],
      "id": "4c7235bc-1632-4d00-8411-c35233cdfb1d",
      "name": "Find Lead (FU1)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "followUpCount": 1,
            "lastEmailSentAt": "={{ $now.toISO() }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        16016,
        304
      ],
      "id": "082c8184-1122-4929-a4fa-194609ec47d5",
      "name": "Update Lead (FU1)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=leadstate_{{ $('Send Follow-Up #1').item.json.leadId || $json.leadId }}",
        "value": "={{ JSON.stringify({ followUpCount: '1', lastEmailSentAt: $now.toISO() }) }}",
        "keyType": "hash"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        16400,
        304
      ],
      "id": "816297f9-ef45-4490-8d37-7ed1d507b551",
      "name": "Redis Update (FU1)",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "=FIND(\"{{ $json.leadId }}\", {leadId})",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        15776,
        464
      ],
      "id": "def3abef-c74b-4dbd-9f37-b4e606d4ba3d",
      "name": "Find Lead (FU2)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "followUpCount": 2,
            "lastEmailSentAt": "={{ $now.toISO() }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        16016,
        464
      ],
      "id": "41dd2710-2821-4f19-adf3-7bcca1a0f95a",
      "name": "Update Lead (FU2)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=leadstate_{{ $('Send Follow-Up #2').item.json.leadId || $json.leadId }}",
        "value": "={{ JSON.stringify({ followUpCount: '2', lastEmailSentAt: $now.toISO() }) }}",
        "keyType": "hash"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        16384,
        464
      ],
      "id": "d8838d32-521a-49bf-9b38-c33f2aabaeca",
      "name": "Redis Update (FU2)",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "=FIND(\"{{ $json.leadId }}\", {leadId})",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        15504,
        624
      ],
      "id": "79059b16-c93a-441b-857f-241a829b6b7b",
      "name": "Find Lead (Unresponsive)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "status": "UNRESPONSIVE"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        15744,
        624
      ],
      "id": "8d31d46d-ce2e-476a-bfaf-ac559b24f1a9",
      "name": "Update Lead (Unresponsive)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=leadstate_{{ $json.leadId }}",
        "value": "={{ JSON.stringify({ status: 'UNRESPONSIVE', markedUnresponsiveAt: $now.toISO() }) }}",
        "keyType": "hash"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        16112,
        624
      ],
      "id": "fc2b5297-27ae-4f55-9032-7136d9634976",
      "name": "Redis Set UNRESPONSIVE",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "=FIND(\"{{ $json.leadId }}\", {leadId})",
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        15776,
        784
      ],
      "id": "adeeb12c-5118-403f-b583-6af733cd06e8",
      "name": "Find Lead (DQ)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "rejectionEmailSentAt": "={{ $now.toISO() }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        16016,
        784
      ],
      "id": "79b65ead-8e5f-4ce5-aa08-f19c4e8599f6",
      "name": "Update Lead (DQ Sent)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=leadstate_{{ $json.leadId }}",
        "value": "={{ JSON.stringify({ rejectionEmailSentAt: $now.toISO() }) }}",
        "keyType": "hash"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        16256,
        784
      ],
      "id": "9cbaf778-a155-432c-8808-d67c70bf5b79",
      "name": "Redis Mark DQ Sent",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "content": "## DISQUALIFICATION 48H GRACE PERIOD\n*Leads auto-rejected by WF1 get 48h for admin review*\n*After 48h with no override → WF8 sends rejection email*",
        "height": 140,
        "width": 1504,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        14896,
        752
      ],
      "id": "8650c2a7-e0e6-48b5-b19c-ae6f4560865b",
      "name": "DQ Grace Period Note"
    },
    {
      "parameters": {
        "workflowId": "F4ZRJbdHVKvYnh5v",
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "leadId": "={{ $json.leadId }}",
            "rejectionReason": "={{ $json.rejectionReason }}",
            "customNote": "Auto-disqualified; 48h grace period expired without admin override"
          }
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        15504,
        784
      ],
      "id": "96dbfd88-2ad4-468d-a748-f1de8fea5c83",
      "name": "Trigger WF8 - Rejection Email1"
    },
    {
      "parameters": {
        "content": "# WF8: REJECTION EMAIL GENERATION\n\n**Trigger:** Called by WF4 when admin rejects a lead\n\n**AI generates personalized rejection/nurture email based on reason:**\n- below_threshold_on_review → Nurturing tone, free resources\n- not_a_fit → Redirecting tone, alternative suggestions\n- incomplete_info → Inviting tone, request more info\n- other → Gracious general response\n\n**Max 120 words. Never mention AI or scoring.**",
        "height": 892,
        "width": 1616,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        16656,
        128
      ],
      "id": "66d47a07-4b78-4594-a4f9-bf8f6550d1b9",
      "name": "WF8 Overview"
    },
    {
      "parameters": {
        "operation": "get",
        "key": "=leadstate_{{ $json.leadId }}",
        "keyType": "hash",
        "options": {}
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        16752,
        544
      ],
      "id": "cdfda598-5eed-4ea1-9b1e-ee7f6c79cfa6",
      "name": "Get Lead State",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const input = $('Called from WF1').first().json;\nconst lead = $('Get Lead State').first().json;\n\nconst firstName = (lead.fullName || '').split(' ')[0];\n\nreturn [{ json: {\n  chatInput: `Rejection reason: ${input.rejectionReason}\\nCustom note from admin: ${input.customNote || ''}\\nClient name: ${firstName}\\nFinancial goals: ${lead.financialGoals || ''}\\nAsset range: ${lead.investableAssets || ''}`,\n  leadId: input.leadId,\n  email: lead.email,\n  fullName: lead.fullName,\n  firstName,\n  rejectionReason: input.rejectionReason,\n  customNote: input.customNote || '',\n  financialGoals: lead.financialGoals || '',\n  investableAssets: lead.investableAssets || ''\n} }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        16992,
        544
      ],
      "id": "fe800976-7e76-45f7-bbe7-beb359f6fe2e",
      "name": "Prep Rejection Context"
    },
    {
      "parameters": {
        "text": "=Rejection reason: {{ $json.rejectionReason }}\nCustom note from admin: {{ $json.customNote }}\nClient name: {{ $json.firstName }}\nFinancial goals: {{ $json.financialGoals }}\nAsset range: {{ $json.investableAssets }}",
        "options": {
          "systemMessage": "You compose rejection/nurture emails for NorthStar Wealth Advisory, a financial advisory firm. Output email body ONLY as plain text — no JSON, no markdown.\n\n## REJECTION TYPES AND TONE\n\n### below_threshold_on_review\nTone: Nurturing. \"We'd love to work with you in the future.\"\nInclude: 2-3 free resources relevant to their goals. Invitation to reconnect.\n- Retirement → link to retirement calculator\n- Tax → CRA resources\n- General → Wealthsimple Invest, Financial Planning Standards Council\n\n### not_a_fit\nTone: Redirecting. \"We want to make sure you get the right help.\"\nInclude: 1-2 alternative suggestions. Debt management → credit counseling referral.\n\n### incomplete_info\nTone: Inviting. \"We'd love to learn more.\"\nInclude: Clear call-to-action to reply or resubmit.\n\n### other\nTone: Gracious. Generic thank-you with open door.\n\n## RULES\n- First name greeting only\n- Maximum 120 words\n- NEVER mention AI, scoring, algorithms, or internal processes\n- NEVER be specific about why rejected\n- Always end with forward-looking positive note\n- Plain text only"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        17232,
        544
      ],
      "id": "4c55aa91-d35c-4121-9138-6af254e0c133",
      "name": "Rejection Email Composer"
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.4
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        17200,
        736
      ],
      "id": "79eef31d-509f-40c0-8da4-a764bdf39755",
      "name": "Gemini (Rejection)",
      "credentials": {
        "googlePalmApi": {
          "id": "gKOxHvioCsyTdrwX",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Build email with appropriate subject based on rejection type\nconst context = $('Prep Rejection Context').first().json;\nconst aiBody = $('Rejection Email Composer').first().json.output || $('Rejection Email Composer').first().json.text || '';\n\nconst subjectMap = {\n  'below_threshold_on_review': 'Resources to help you on your financial journey',\n  'not_a_fit': 'Some recommendations for your financial goals',\n  'incomplete_info': \"We'd love to learn more\",\n  'other': 'Thank you for your interest'\n};\n\nconst subject = (subjectMap[context.rejectionReason] || subjectMap['other']) + ' — NorthStar Wealth Advisory';\n\nreturn [{ json: {\n  to: context.email,\n  subject,\n  body: aiBody,\n  leadId: context.leadId\n} }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        17536,
        544
      ],
      "id": "713bcae9-b1e0-4ac0-bbc9-b037c5dac598",
      "name": "Build Email"
    },
    {
      "parameters": {
        "sendTo": "={{ $json.to }}",
        "subject": "={{ $json.subject }}",
        "message": "={{ $json.body }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        17744,
        544
      ],
      "id": "53fe608f-ab46-4b7a-9fa7-6122c1fd67ba",
      "name": "Send Rejection Email",
      "webhookId": "d3f2568b-5672-435f-bfee-4472c397f430",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "=leadstate_{{ $('Build Email').first().json.leadId }}",
        "value": "={{ JSON.stringify({ rejectionEmailSentAt: $now.toISO() }) }}",
        "keyType": "hash"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        17968,
        544
      ],
      "id": "00eb997a-4e83-4aaa-af44-ca1661a1d2a9",
      "name": "Mark Rejection Sent",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Fallback: send generic rejection template on AI failure\nconst context = $('Prep Rejection Context').first().json;\nreturn [{ json: {\n  to: context.email,\n  subject: 'Thank you for your interest — NorthStar Wealth Advisory',\n  body: `Hi ${context.firstName},\\n\\nThank you for reaching out to NorthStar Wealth Advisory. We appreciate you sharing your financial goals with us.\\n\\nAt this time, we believe you may be better served by resources that more closely align with your current needs. Here are some excellent options:\\n\\n- Wealthsimple Invest (wealthsimple.com)\\n- Financial Planning Standards Council (fpsc.ca)\\n\\nShould your circumstances change, we'd love to hear from you again.\\n\\nWarm regards,\\nNorthStar Wealth Advisory`,\n  leadId: context.leadId\n} }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        17760,
        768
      ],
      "id": "11d14c37-b409-4b76-91c8-51f06d60846d",
      "name": "Fallback Template"
    },
    {
      "parameters": {
        "sendTo": "={{ $json.to }}",
        "subject": "={{ $json.subject }}",
        "message": "={{ $json.body }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        18000,
        768
      ],
      "id": "d2551b0b-c9d3-4cf3-ab84-45a22da9476f",
      "name": "Send Fallback Email",
      "webhookId": "ed30050a-22b6-499f-867f-2911b15068f7",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "content": "# WF9: BUSINESS DATA CACHE REFRESH\n\n**FIXED:** All 5 Airtable fetches run in PARALLEL from a single trigger item.\nPrevious version chained them causing 42,000+ item explosion.",
        "height": 1432,
        "width": 1960
      },
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        18288,
        -112
      ],
      "id": "1d63692e-dae1-4745-b194-117d6ca13f61",
      "name": "WF9 Overview"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {},
            {
              "triggerAtHour": 6
            },
            {
              "triggerAtHour": 12
            },
            {
              "triggerAtHour": 18
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        18336,
        256
      ],
      "id": "3763c10d-963f-40d5-972a-d1bf519c9c53",
      "name": "Every 6 Hours"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "cache-refresh",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        18336,
        464
      ],
      "id": "dbd1ceef-84f3-4666-af5c-1c9b5143e330",
      "name": "Webhook - Cache Refresh",
      "webhookId": "10dfad0d-c4dc-4d3a-95b5-bd3e70e31481"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [
        18336,
        656
      ],
      "id": "ae1086be-f373-457e-b0c4-b61b8b303fb2",
      "name": "Manual Trigger"
    },
    {
      "parameters": {
        "jsCode": "return [{ json: { trigger: 'cache_refresh', timestamp: new Date().toISOString() } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        18608,
        464
      ],
      "id": "f29563c1-4796-4f7d-b151-df093f24d257",
      "name": "Set Trigger Flag"
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblHTsE90vHoMv91I",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        18896,
        160
      ],
      "id": "010aaa18-434f-47fa-abef-c26d0d64db5a",
      "name": "Fetch Advisor Info (Airtable)",
      "executeOnce": true,
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblk9vQT3dDivYuo0",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        18896,
        352
      ],
      "id": "42821f30-55ae-472c-964c-2f240a381b3a",
      "name": "Fetch Consultation Services (Airtable)",
      "executeOnce": true,
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tbliUX7QurrQwFNbQ",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        18896,
        528
      ],
      "id": "247e05be-44b5-4d53-8033-9b569d27d564",
      "name": "Fetch Advisor Availability (Airtable)",
      "executeOnce": true,
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblXKvNO3oEOUwabe",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        18896,
        704
      ],
      "id": "bbd2d0f9-4b97-4199-af4d-8f099abf574c",
      "name": "Fetch Configuration (Airtable)",
      "executeOnce": true,
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tbltY5quYso4mq655",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        18896,
        880
      ],
      "id": "0d50943a-c967-448a-82ab-a52d220f1af6",
      "name": "Fetch Email Templates (Airtable)",
      "executeOnce": true,
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const advisorRows = $('Fetch Advisor Info (Airtable)').all().map(i => i.json);\nconst serviceRows = $('Fetch Consultation Services (Airtable)').all().map(i => i.json);\nconst availRows = $('Fetch Advisor Availability (Airtable)').all().map(i => i.json);\nconst configRows = $('Fetch Configuration (Airtable)').all().map(i => i.json);\nconst templateRows = $('Fetch Email Templates (Airtable)').all().map(i => i.json);\n\nconst advisors = advisorRows.map(r => ({\n  advisorId: r.advisorId,\n  name: r.name,\n  email: r.email,\n  calendarId: r.calendarId,\n  specializations: (r.specializations || '').split(',').map(s => s.trim()).filter(Boolean),\n  currentCaseload: Number(r.currentCaseload) || 0,\n  maxCaseload: Number(r.maxCaseload) || 25,\n  bio: r.bio || ''\n}));\n\nconst serviceTiers = serviceRows.map(r => ({\n  tierId: r.tierId,\n  tierName: r.tierName,\n  description: r.description,\n  qualifyingGoals: (r.qualifyingGoals || '').split(',').map(s => s.trim()).filter(Boolean),\n  minAssets: r.minAssets\n}));\n\nconst availability = availRows.map(r => ({\n  date: r.date,\n  advisorId: r.advisorId,\n  advisorName: r.advisorName,\n  workingHours: r.workingHours,\n  blockedTimes: r.blockedTimes || ''\n}));\n\nconst config = {};\nconfigRows.forEach(r => {\n  if (!r.key) return;\n  let val = r.value;\n  try { val = JSON.parse(val); } catch(e) {}\n  config[r.key] = val;\n});\n\nconst templates = {};\ntemplateRows.forEach(r => {\n  if (!r.templateKey) return;\n  templates[r.templateKey] = { subject: r.subject, body: r.body };\n});\n\nreturn [{\n  json: {\n    advisors: JSON.stringify(advisors),\n    serviceTiers: JSON.stringify(serviceTiers),\n    availability: JSON.stringify(availability),\n    config: JSON.stringify(config),\n    templates: JSON.stringify(templates),\n    refreshedAt: new Date().toISOString(),\n    keysCount: 5\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        19216,
        528
      ],
      "id": "5117247a-7b35-403f-bdc9-e150bac25ef0",
      "name": "Build Cache Objects",
      "executeOnce": true
    },
    {
      "parameters": {
        "operation": "set",
        "key": "firm:advisors",
        "value": "={{ $json.advisors }}",
        "keyType": "string"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        19488,
        160
      ],
      "id": "1b21b986-e71a-48d9-b763-3965b131de40",
      "name": "Cache Advisors",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "firm:service_tiers",
        "value": "={{ $json.serviceTiers }}",
        "keyType": "string"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        19488,
        352
      ],
      "id": "d62c163b-31e7-4fc5-8a6a-485b411c4ff4",
      "name": "Cache Service Tiers",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "firm:advisor_availability",
        "value": "={{ $json.availability }}",
        "keyType": "string"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        19488,
        528
      ],
      "id": "0f378341-94eb-4144-8d90-a885586d75ba",
      "name": "Cache Availability",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "firm:config",
        "value": "={{ $json.config }}",
        "keyType": "string"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        19488,
        704
      ],
      "id": "d714172d-7f40-49db-ba7d-4a3322186f3f",
      "name": "Cache Config",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "operation": "set",
        "key": "firm:email_templates",
        "value": "={{ $json.templates }}",
        "keyType": "string"
      },
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        19488,
        880
      ],
      "id": "81b2c231-6e67-4c54-88aa-455089798ae9",
      "name": "Cache Email Templates",
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const refreshedAt = $('Build Cache Objects').first().json.refreshedAt;\nconst keysCount = $('Build Cache Objects').first().json.keysCount;\nreturn [{ json: { timestamp: refreshedAt, event: 'CACHE_REFRESH', details: `Refreshed ${keysCount} cache keys`, status: 'SUCCESS' } }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        19728,
        704
      ],
      "id": "18e689af-3d92-447b-993f-320e8256cb6a",
      "name": "Log Refresh Success"
    },
    {
      "parameters": {
        "operation": "create",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblrmQkgKQg3Va9vA",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp": "={{ $json.timestamp }}",
            "event": "={{ $json.event }}",
            "details": "={{ $json.details }}",
            "status": "={{ $json.status }}"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        19968,
        704
      ],
      "id": "cf170c2a-3be4-4465-8e25-d4776ffae171",
      "name": "Write System Log (Airtable)",
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "smuharsk@gmail.com",
        "subject": "WF9 Cache Refresh FAILED",
        "message": "=Cache refresh failed at {{ $now.toISO() }}\n\nError: {{ $json.error?.message || JSON.stringify($json) }}",
        "options": {}
      },
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        19728,
        1104
      ],
      "id": "a7d31dd3-7829-44b4-b47f-cb01e91e224a",
      "name": "Send Error Alert",
      "webhookId": "b7c8c65f-3532-4b45-a52d-1dafa97db558",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "content": "# WF10: CONSULTATION PREP BRIEF GENERATOR\n\n**Purpose:** AI generates a substantive meeting preparation document for the assigned advisor before each consultation. Goes far beyond conversation starters — produces actionable financial analysis.\n\n**Triggers:**\n1. Called by WF5/WF6 after booking is confirmed (leadId input)\n2. Schedule: Daily at 7 AM ET — finds BOOKED leads with appointments in the next 48h that don't yet have a prep brief\n3. Manual: Click Execute\n\n**Output:**\n- consultationPrepBrief field written to Leads table in Airtable\n- Email sent to assigned advisor with the brief\n\n**AI generates:**\n- Financial situation analysis (asset allocation context, income-to-asset ratio)\n- Goal-specific preparation (retirement gap analysis, tax optimization angles)\n- Client psychology profile (risk tolerance vs actual behavior signals)\n- Market context talking points (current rates, relevant regulatory changes)\n- Recommended meeting agenda with time blocks\n- Red flags requiring delicate handling\n- Documents to request from client",
        "height": 1520,
        "width": 3532,
        "color": 7
      },
      "id": "5e3d7d4b-fc1b-4ba1-bf55-69524edb5380",
      "name": "WF10 Overview",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        20256,
        -144
      ]
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 12
            }
          ]
        }
      },
      "id": "f46e1a5c-f44e-49d3-9584-07c467183bff",
      "name": "Daily 7 AM ET",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        20480,
        704
      ]
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "=AND({status}='BOOKED', {consultationPrepBrief}='', {appointmentDatetime}!='')",
        "options": {}
      },
      "id": "d0db8385-a9b3-4669-b7cd-476829264f3d",
      "name": "Find Upcoming Appointments",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        20752,
        784
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-results",
              "leftValue": "={{ $json.leadId }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isNotEmpty",
                "singleValue": true
              }
            }
          ]
        },
        "options": {}
      },
      "id": "6880f679-ef1e-44c7-b0c5-2b4267437373",
      "name": "Any Leads to Prep?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        20992,
        784
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst results = [];\nfor (const item of items) {\n  const r = item.json;\n  const fields = r.fields || r;\n  results.push({\n    json: {\n      airtableRecordId: r.id || '',\n      leadId: fields.leadId,\n      fullName: fields.fullName,\n      email: fields.email,\n      phone: fields.phone || '',\n      province: fields.province,\n      investableAssets: fields.investableAssets,\n      annualIncome: fields.annualIncome,\n      financialGoals: fields.financialGoals,\n      investmentTimeline: fields.investmentTimeline,\n      riskTolerance: fields.riskTolerance,\n      currentAdvisorSituation: fields.currentAdvisorSituation,\n      preferredDate: fields.preferredDate || '',\n      preferredTime: fields.preferredTime || '',\n      freeText: fields.freeText || '',\n      profileSummary: fields.profileSummary || '',\n      recommendedServiceTier: fields.recommendedServiceTier || '',\n      advisorMatchRanking: fields.advisorMatchRanking || '[]',\n      riskFlags: fields.riskFlags || '[]',\n      conversationStarters: fields.conversationStarters || '[]',\n      priorityScore: fields.priorityScore || '',\n      priorityReasoning: fields.priorityReasoning || '',\n      assignedAdvisorId: fields.assignedAdvisorId || '',\n      assignedAdvisorName: fields.assignedAdvisorName || '',\n      appointmentDatetime: fields.appointmentDatetime || '',\n      bookedAt: fields.bookedAt || '',\n      submittedAt: fields.submittedAt || ''\n    }\n  });\n}\nreturn results;"
      },
      "id": "adb00f94-5898-4f69-a91b-84dcab97f7cb",
      "name": "Merge to Common Path",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        21232,
        592
      ]
    },
    {
      "parameters": {
        "operation": "get",
        "key": "firm:advisors",
        "options": {}
      },
      "id": "4660d34b-38ec-40a7-89cc-8d61ac237b04",
      "name": "Get Advisors + Config",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        21472,
        592
      ],
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const lead = $('Merge to Common Path').first().json;\nlet advisorsRaw = $('Get Advisors + Config').first().json;\nlet configRaw = $('Get Firm Config1').first().json;\n\nlet advisors = [];\nlet config = {};\ntry {\n  if (typeof advisorsRaw === 'string') advisors = JSON.parse(advisorsRaw);\n  else if (advisorsRaw?.data) advisors = JSON.parse(advisorsRaw.data);\n  else if (advisorsRaw?.propertyName && advisorsRaw.propertyName !== 'null') advisors = JSON.parse(advisorsRaw.propertyName);\n} catch(e) { advisors = []; }\ntry {\n  if (typeof configRaw === 'string') config = JSON.parse(configRaw);\n  else if (configRaw?.data) config = JSON.parse(configRaw.data);\n  else if (configRaw?.propertyName && configRaw.propertyName !== 'null') config = JSON.parse(configRaw.propertyName);\n} catch(e) { config = {}; }\n\nconst assignedAdvisor = advisors.find(a => a.advisorId === lead.assignedAdvisorId) || { advisorName: lead.assignedAdvisorName, specializations: '' };\n\nlet riskFlags = [];\nlet serviceTier = {};\nlet conversationStarters = [];\ntry { riskFlags = JSON.parse(lead.riskFlags || '[]'); } catch(e) {}\ntry { serviceTier = JSON.parse(lead.recommendedServiceTier || '{}'); } catch(e) {}\ntry { conversationStarters = JSON.parse(lead.conversationStarters || '[]'); } catch(e) {}\n\nconst now = new Date();\nconst apptDate = lead.appointmentDatetime ? new Date(lead.appointmentDatetime) : null;\nconst hoursUntil = apptDate ? Math.round((apptDate - now) / (1000*60*60)) : 'unknown';\n\nconst assetRanges = { 'under_25k': 15000, '25k_100k': 62500, '100k_250k': 175000, '250k_500k': 375000, '500k_1m': 750000, '1m_plus': 1500000 };\nconst incomeRanges = { 'under_50k': 35000, '50k_100k': 75000, '100k_200k': 150000, '200k_500k': 350000, '500k_plus': 750000 };\nconst estAssets = assetRanges[lead.investableAssets] || 0;\nconst estIncome = incomeRanges[lead.annualIncome] || 0;\nconst assetToIncomeRatio = estIncome > 0 ? (estAssets / estIncome).toFixed(1) : 'N/A';\n\nreturn [{ json: {\n  ...lead,\n  advisorProfile: assignedAdvisor,\n  riskFlagsParsed: riskFlags,\n  serviceTierParsed: serviceTier,\n  conversationStartersParsed: conversationStarters,\n  hoursUntilAppointment: hoursUntil,\n  estimatedAssets: estAssets,\n  estimatedIncome: estIncome,\n  assetToIncomeRatio: assetToIncomeRatio,\n  firmName: config.firm_name || 'NorthStar Wealth Advisory',\n  consultationDuration: config.consultation_duration_minutes || 60,\n  timezone: config.timezone || 'America/Toronto'\n} }];"
      },
      "id": "2495d0e1-43a6-431d-9b87-c6392436e06c",
      "name": "Build AI Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        21952,
        592
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Generate a consultation preparation brief for this upcoming client meeting.\n\n## CLIENT PROFILE\nName: {{ $json.fullName }}\nProvince: {{ $json.province }}\nInvestable Assets: {{ $json.investableAssets }} (est. ${{ $json.estimatedAssets.toLocaleString() }})\nAnnual Income: {{ $json.annualIncome }} (est. ${{ $json.estimatedIncome.toLocaleString() }})\nAsset-to-Income Ratio: {{ $json.assetToIncomeRatio }}x\nFinancial Goals: {{ $json.financialGoals }}\nInvestment Timeline: {{ $json.investmentTimeline }}\nRisk Tolerance: {{ $json.riskTolerance }}\nCurrent Advisor Situation: {{ $json.currentAdvisorSituation }}\nFree Text from Client: {{ $json.freeText }}\n\n## AI ENRICHMENT SUMMARY\nProfile Summary: {{ $json.profileSummary }}\nService Tier: {{ JSON.stringify($json.serviceTierParsed) }}\nPriority: {{ $json.priorityScore }} — {{ $json.priorityReasoning }}\nRisk Flags: {{ JSON.stringify($json.riskFlagsParsed) }}\nExisting Conversation Starters: {{ JSON.stringify($json.conversationStartersParsed) }}\n\n## MEETING DETAILS\nAssigned Advisor: {{ $json.assignedAdvisorName }} ({{ $json.advisorProfile.specializations }})\nAppointment: {{ $json.appointmentDatetime }}\nDuration: {{ $json.consultationDuration }} minutes\nHours Until Meeting: {{ $json.hoursUntilAppointment }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are a senior financial planning consultant preparing briefing documents for wealth advisors at NorthStar Wealth Advisory (Toronto, Canada). Your briefs are used by advisors to walk into first consultations fully prepared — as if they've already studied this client for an hour.\n\nYou write like a sharp, experienced advisor briefing a colleague: direct, analytical, no fluff. Every line should make the advisor more prepared.\n\n## OUTPUT SCHEMA (JSON only)\n{\n  \"executiveSummary\": \"2-3 sentences. Lead with the single most important thing the advisor needs to know walking in. What makes this client tick, and what's the #1 opportunity?\",\n  \"financialSnapshot\": {\n    \"assetContext\": \"Interpret asset range in context. What does $250K-500K mean for someone in their situation? How does it compare to Canadian median?\",\n    \"incomeAssetDynamic\": \"What does the asset-to-income ratio tell us? Are they a saver, spender, or did wealth come from elsewhere (inheritance, sale, etc.)?\",\n    \"wealthTrajectory\": \"Based on timeline + risk tolerance + goals, where are they likely headed? What's realistic?\"\n  },\n  \"goalAnalysis\": [\n    {\n      \"goal\": \"goal name\",\n      \"keyQuestions\": [\"2-3 specific financial questions to ask\"],\n      \"quickMath\": \"Back-of-napkin calculation or benchmark. E.g., 'At 6% avg return over 10yr, $375K grows to ~$670K before contributions. If they need $1.2M for retirement, that's a $350/mo gap.'\",\n      \"canadianContext\": \"Relevant Canadian-specific angle: RRSP room, TFSA strategy, RESP if education, principal residence exemption if estate, etc.\"\n    }\n  ],\n  \"clientPsychologyNotes\": {\n    \"riskProfile\": \"Interpret stated risk tolerance against their actual situation. Does aggressive + 5yr timeline make sense? Are they actually moderate but checking aggressive?\",\n    \"advisorRelationship\": \"If switching: why? What went wrong? If first-time: what are they nervous about?\",\n    \"decisionMakingStyle\": \"From the intake signals, how should the advisor present options?\"\n  },\n  \"meetingAgenda\": [\n    {\n      \"timeBlock\": \"0-10 min\",\n      \"activity\": \"what to do\",\n      \"advisorNotes\": \"specific talking points or techniques\"\n    }\n  ],\n  \"documentsToRequest\": [\"List of specific documents the advisor should ask the client to bring or send\"],\n  \"redFlagsAndLandmines\": [\"Things that could go wrong. Sensitive topics. Unrealistic expectations to manage.\"],\n  \"competitiveIntelligence\": \"If switching firms, what can we infer about what they want that they weren't getting?\"\n}\n\n## RULES\n- Ground every number in intake data or Canadian financial benchmarks\n- Reference RRSP ($31,560 limit 2025), TFSA ($7,000/yr), RESP ($2,500/yr CESG match) where relevant\n- For retirement: reference CPP (max ~$16,375/yr at 65), OAS (~$8,560/yr)\n- For tax: reference Ontario marginal rates, capital gains inclusion, dividend tax credits\n- If inheritance mentioned: flag Ontario probate fees (1.5% over $50K)\n- Meeting agenda should total the consultation duration\n- Be specific, not generic. 'Ask about RRSP room' beats 'discuss retirement'\n- Output ONLY valid JSON matching the schema. No markdown, no backticks, no preamble."
        }
      },
      "id": "dcdf9d8d-0658-4464-9b29-c13a6ba47852",
      "name": "Consultation Prep Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        22192,
        592
      ]
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.3
        }
      },
      "id": "7ac600f4-2c9a-4d90-be6b-1c1608169baf",
      "name": "Gemini 2.5 Flash (Prep)",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        22144,
        832
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "gKOxHvioCsyTdrwX",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{ \"type\": \"object\", \"properties\": { \"executiveSummary\": { \"type\": \"string\" }, \"financialSnapshot\": { \"type\": \"object\", \"properties\": { \"assetContext\": { \"type\": \"string\" }, \"incomeAssetDynamic\": { \"type\": \"string\" }, \"wealthTrajectory\": { \"type\": \"string\" } }, \"required\": [\"assetContext\", \"incomeAssetDynamic\", \"wealthTrajectory\"] }, \"goalAnalysis\": { \"type\": \"array\", \"items\": { \"type\": \"object\", \"properties\": { \"goal\": { \"type\": \"string\" }, \"keyQuestions\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } }, \"quickMath\": { \"type\": \"string\" }, \"canadianContext\": { \"type\": \"string\" } }, \"required\": [\"goal\", \"keyQuestions\", \"quickMath\", \"canadianContext\"] } }, \"clientPsychologyNotes\": { \"type\": \"object\", \"properties\": { \"riskProfile\": { \"type\": \"string\" }, \"advisorRelationship\": { \"type\": \"string\" }, \"decisionMakingStyle\": { \"type\": \"string\" } }, \"required\": [\"riskProfile\", \"advisorRelationship\", \"decisionMakingStyle\"] }, \"meetingAgenda\": { \"type\": \"array\", \"items\": { \"type\": \"object\", \"properties\": { \"timeBlock\": { \"type\": \"string\" }, \"activity\": { \"type\": \"string\" }, \"advisorNotes\": { \"type\": \"string\" } }, \"required\": [\"timeBlock\", \"activity\", \"advisorNotes\"] } }, \"documentsToRequest\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } }, \"redFlagsAndLandmines\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } }, \"competitiveIntelligence\": { \"type\": \"string\" } }, \"required\": [\"executiveSummary\", \"financialSnapshot\", \"goalAnalysis\", \"clientPsychologyNotes\", \"meetingAgenda\", \"documentsToRequest\", \"redFlagsAndLandmines\", \"competitiveIntelligence\"] }"
      },
      "id": "95c1da34-d692-43d5-9c67-b80aca839bf3",
      "name": "Prep Brief Schema",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        22336,
        832
      ]
    },
    {
      "parameters": {
        "jsCode": "const agentOutput = $('Consultation Prep Agent').first().json;\nconst lead = $('Build AI Prompt').first().json;\n\nconst brief = agentOutput.output\n  ? (typeof agentOutput.output === 'string' ? JSON.parse(agentOutput.output) : agentOutput.output)\n  : agentOutput;\n\nconst briefJson = JSON.stringify(brief);\n\nconst apptDate = lead.appointmentDatetime ? new Date(lead.appointmentDatetime) : null;\nconst formattedDate = apptDate ? apptDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : 'TBD';\nconst formattedTime = apptDate ? apptDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true }) : 'TBD';\n\nconst agendaHtml = (brief.meetingAgenda || []).map(a =>\n  `<tr><td style=\"padding:8px;border:1px solid #e2e8f0;font-weight:600;width:100px;\">${a.timeBlock}</td><td style=\"padding:8px;border:1px solid #e2e8f0;\"><strong>${a.activity}</strong><br/><span style=\"color:#64748b;font-size:13px;\">${a.advisorNotes}</span></td></tr>`\n).join('');\n\nconst goalsHtml = (brief.goalAnalysis || []).map(g =>\n  `<div style=\"margin-bottom:16px;padding:12px;background:#f0f9ff;border-radius:8px;\"><h4 style=\"margin:0 0 8px;color:#0f172a;\">Target: ${g.goal}</h4><p style=\"margin:4px 0;font-size:14px;\"><strong>Quick Math:</strong> ${g.quickMath}</p><p style=\"margin:4px 0;font-size:14px;\"><strong>Canadian Context:</strong> ${g.canadianContext}</p><p style=\"margin:4px 0;font-size:14px;\"><strong>Key Questions:</strong></p><ul style=\"margin:4px 0;\">${g.keyQuestions.map(q => `<li style=\"font-size:14px;\">${q}</li>`).join('')}</ul></div>`\n).join('');\n\nconst docsHtml = (brief.documentsToRequest || []).map(d => `<li>${d}</li>`).join('');\nconst flagsHtml = (brief.redFlagsAndLandmines || []).map(f => `<li style=\"color:#dc2626;\">${f}</li>`).join('');\n\nconst emailBody = `<div style=\"font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;max-width:680px;margin:0 auto;\"><div style=\"background:#0f172a;color:white;padding:24px 32px;border-radius:12px 12px 0 0;\"><h1 style=\"margin:0;font-size:22px;\">Consultation Prep Brief</h1><p style=\"margin:8px 0 0;opacity:0.8;font-size:14px;\">${lead.fullName} — ${formattedDate} at ${formattedTime} ET</p></div><div style=\"padding:24px 32px;background:white;border:1px solid #e2e8f0;\"><div style=\"background:#fefce8;border-left:4px solid #eab308;padding:16px;margin-bottom:24px;border-radius:0 8px 8px 0;\"><h3 style=\"margin:0 0 8px;color:#854d0e;\">Executive Summary</h3><p style=\"margin:0;font-size:15px;line-height:1.5;\">${brief.executiveSummary}</p></div><h3 style=\"color:#0f172a;border-bottom:2px solid #e2e8f0;padding-bottom:8px;\">Financial Snapshot</h3><p><strong>Asset Context:</strong> ${brief.financialSnapshot?.assetContext || ''}</p><p><strong>Income-Asset Dynamic:</strong> ${brief.financialSnapshot?.incomeAssetDynamic || ''}</p><p><strong>Wealth Trajectory:</strong> ${brief.financialSnapshot?.wealthTrajectory || ''}</p><h3 style=\"color:#0f172a;border-bottom:2px solid #e2e8f0;padding-bottom:8px;\">Goal Analysis</h3>${goalsHtml}<h3 style=\"color:#0f172a;border-bottom:2px solid #e2e8f0;padding-bottom:8px;\">Client Psychology</h3><p><strong>Risk Profile:</strong> ${brief.clientPsychologyNotes?.riskProfile || ''}</p><p><strong>Advisor Relationship:</strong> ${brief.clientPsychologyNotes?.advisorRelationship || ''}</p><p><strong>Decision-Making Style:</strong> ${brief.clientPsychologyNotes?.decisionMakingStyle || ''}</p>${brief.competitiveIntelligence ? `<h3 style=\"color:#0f172a;border-bottom:2px solid #e2e8f0;padding-bottom:8px;\">Competitive Intelligence</h3><p>${brief.competitiveIntelligence}</p>` : ''}<h3 style=\"color:#0f172a;border-bottom:2px solid #e2e8f0;padding-bottom:8px;\">Recommended Meeting Agenda</h3><table style=\"width:100%;border-collapse:collapse;\">${agendaHtml}</table><h3 style=\"color:#0f172a;border-bottom:2px solid #e2e8f0;padding-bottom:8px;\">Documents to Request</h3><ul>${docsHtml}</ul>${flagsHtml ? `<h3 style=\"color:#dc2626;border-bottom:2px solid #fecaca;padding-bottom:8px;\">Red Flags and Landmines</h3><ul>${flagsHtml}</ul>` : ''}</div><div style=\"background:#f8fafc;padding:16px 32px;border-radius:0 0 12px 12px;border:1px solid #e2e8f0;border-top:0;text-align:center;\"><p style=\"margin:0;color:#64748b;font-size:13px;\">Generated by NorthStar AI Pipeline</p></div></div>`;\n\nreturn [{ json: {\n  leadId: lead.leadId,\n  airtableRecordId: lead.airtableRecordId,\n  assignedAdvisorName: lead.assignedAdvisorName,\n  assignedAdvisorId: lead.assignedAdvisorId,\n  clientName: lead.fullName,\n  clientEmail: lead.email,\n  briefJson,\n  emailBody,\n  emailSubject: `Prep Brief: ${lead.fullName} — ${formattedDate} at ${formattedTime} ET`,\n  appointmentDatetime: lead.appointmentDatetime\n} }];"
      },
      "id": "6195d054-40e4-4375-8f8a-b100ef075dc5",
      "name": "Process Brief Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        22480,
        592
      ]
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "={leadId}='{{ $('Process Brief Output').first().json.leadId }}'",
        "options": {}
      },
      "id": "3fdcc6d1-f882-42c1-be0b-80781175d591",
      "name": "Find Lead Record",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        22720,
        592
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.id }}",
            "consultationPrepBrief": "={{ $('Process Brief Output').first().json.briefJson }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "59d81bdc-016c-4b8e-a7c3-0e056c274efb",
      "name": "Save Brief to Airtable",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        22960,
        592
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "smuharsk@gmail.com",
        "subject": "={{ $('Process Brief Output').first().json.emailSubject }}",
        "message": "={{ $('Process Brief Output').first().json.emailBody }}",
        "options": {}
      },
      "id": "46ad0439-bd06-4efd-ae75-47556b2da0c7",
      "name": "Email Brief to Advisor",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        23200,
        592
      ],
      "webhookId": "1d5da68a-08dc-4da3-8882-a68e1ed3c62b",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const errorData = $input.first().json;\nreturn [{ json: { error: errorData, action: 'PREP_BRIEF_FAILED', timestamp: new Date().toISOString() } }];"
      },
      "id": "15a77e48-c7c9-427d-8c1b-ec0cd7075cd0",
      "name": "Handle Prep Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        22128,
        1168
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "value": "pD0jBk6n4k3HXT3W",
          "mode": "id"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "leadId": "={{ $('Process Brief Output').first().json.leadId }}",
            "briefJson": "={{ $('Process Brief Output').first().json.briefJson }}",
            "clientName": "={{ $('Process Brief Output').first().json.clientName }}",
            "clientEmail": "={{ $('Process Brief Output').first().json.clientEmail }}",
            "advisorName": "={{ $('Process Brief Output').first().json.assignedAdvisorName }}",
            "advisorId": "={{ $('Process Brief Output').first().json.assignedAdvisorId }}",
            "appointmentDatetime": "={{ $('Process Brief Output').first().json.appointmentDatetime }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "leadId",
              "displayName": "leadId",
              "type": "string"
            },
            {
              "id": "briefJson",
              "displayName": "briefJson",
              "type": "string"
            },
            {
              "id": "clientName",
              "displayName": "clientName",
              "type": "string"
            },
            {
              "id": "clientEmail",
              "displayName": "clientEmail",
              "type": "string"
            },
            {
              "id": "advisorName",
              "displayName": "advisorName",
              "type": "string"
            },
            {
              "id": "advisorId",
              "displayName": "advisorId",
              "type": "string"
            },
            {
              "id": "appointmentDatetime",
              "displayName": "appointmentDatetime",
              "type": "string"
            }
          ]
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "id": "298a5cf8-019b-48bb-9b11-9cbecbb87482",
      "name": "Trigger WF11 - Nurture Draft",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.2,
      "position": [
        23440,
        592
      ]
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "={leadId}='{{ $json.leadId }}'",
        "options": {}
      },
      "id": "68b489fd-f519-4118-be3e-2103d63aaf28",
      "name": "Get Lead from Airtable2",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        20752,
        464
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "key": "firm:config",
        "options": {}
      },
      "id": "cf6dc9a0-a2b7-4521-a6ac-6b8b5060e6af",
      "name": "Get Firm Config1",
      "type": "n8n-nodes-base.redis",
      "typeVersion": 1,
      "position": [
        21712,
        592
      ],
      "credentials": {
        "redis": {
          "id": "VgHjJLwct64e99fI",
          "name": "Redis account"
        }
      }
    },
    {
      "parameters": {
        "sendTo": "smuharsk@gmail.com",
        "subject": "WF10 Prep Brief FAILED — NorthStar Pipeline",
        "message": "=Consultation Prep Brief generation failed at {{ $now.toISO() }}\n\nError: {{ JSON.stringify($json.error) }}\n\nLead may need manual brief preparation.",
        "options": {}
      },
      "id": "aafb1b9f-c8ba-4d81-8c06-5492447d08a4",
      "name": "Send Error Alert1",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        22368,
        1168
      ],
      "webhookId": "052ee5a0-18d7-4b4d-ab64-15a188e7fb14",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "content": "# WF11: PRE-MEETING NURTURE EMAIL DRAFTS (with Compliance Guardrails)\n\n**Purpose:** AI drafts a personalized rapport-building email, then a SEPARATE Compliance Guardrails Agent reviews it against firm policies (via RAG/Pinecone) before saving.\n\n**Flow:**\n1. WF10 completes → calls WF11 with leadId\n2. AI Nurture Agent drafts warm, personalized email\n3. ⭐ Compliance Guardrails Agent reviews draft against embedded policy docs (Pinecone)\n4. If violations found: auto-revises text, flags compliance notes\n5. Draft saved to Airtable with compliance metadata\n6. Dashboard shows draft with Send / Dismiss buttons\n7. Send → returns mailto: link (advisor sends from their own email)\n\n**Two-agent pattern:** Generation agent + Review agent. Same Pinecone index, different purposes.\n**The human always sends the email themselves.** AI drafts, AI reviews, human decides.",
        "height": 1624,
        "width": 3052,
        "color": 4
      },
      "id": "65488d21-f538-4dad-97b0-47b90d39087a",
      "name": "WF11 Overview",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        23792,
        -144
      ]
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "={leadId}='{{ $json.leadId }}'",
        "options": {}
      },
      "id": "f9db80e3-53b4-48dd-8a1f-412a04b934d0",
      "name": "Load Lead + Brief",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        24832,
        368
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const trigger = $('Called from WF1').first().json;\nconst record = $('Load Lead + Brief').first().json;\nconst fields = record.fields || record;\n\n// Parse the prep brief\nlet brief = {};\ntry {\n  const briefRaw = trigger.briefJson || fields.consultationPrepBrief || '{}';\n  brief = typeof briefRaw === 'string' ? JSON.parse(briefRaw) : briefRaw;\n} catch(e) { brief = {}; }\n\nconst apptDate = trigger.appointmentDatetime || fields.appointmentDatetime;\nlet formattedDate = 'your upcoming consultation';\nlet formattedTime = '';\nif (apptDate) {\n  const d = new Date(apptDate);\n  formattedDate = d.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });\n  formattedTime = d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });\n}\n\nreturn [{ json: {\n  leadId: fields.leadId || trigger.leadId,\n  airtableRecordId: record.id,\n  clientName: fields.fullName || trigger.clientName,\n  clientFirstName: (fields.fullName || trigger.clientName || '').split(' ')[0],\n  clientEmail: fields.email || trigger.clientEmail,\n  advisorName: fields.assignedAdvisorName || trigger.advisorName,\n  advisorId: fields.assignedAdvisorId || trigger.advisorId,\n  appointmentDatetime: apptDate,\n  formattedDate,\n  formattedTime,\n  province: fields.province || '',\n  investableAssets: fields.investableAssets || '',\n  financialGoals: fields.financialGoals || '',\n  investmentTimeline: fields.investmentTimeline || '',\n  riskTolerance: fields.riskTolerance || '',\n  currentAdvisorSituation: fields.currentAdvisorSituation || '',\n  freeText: fields.freeText || '',\n  // Prep brief sections for the AI\n  executiveSummary: brief.executiveSummary || '',\n  financialSnapshot: brief.financialSnapshot || {},\n  goalAnalysis: brief.goalAnalysis || [],\n  clientPsychologyNotes: brief.clientPsychologyNotes || {},\n  competitiveIntelligence: brief.competitiveIntelligence || '',\n  documentsToRequest: brief.documentsToRequest || []\n} }];"
      },
      "id": "77877343-b39e-4d34-9240-22e7852062c8",
      "name": "Build Nurture Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        25072,
        368
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Draft a pre-meeting rapport-building email from {{ $json.advisorName }} to {{ $json.clientFirstName }}.\n\n## CLIENT CONTEXT\nFull Name: {{ $json.clientName }}\nProvince: {{ $json.province }}\nAssets: {{ $json.investableAssets }}\nGoals: {{ $json.financialGoals }}\nTimeline: {{ $json.investmentTimeline }}\nRisk Tolerance: {{ $json.riskTolerance }}\nAdvisor Situation: {{ $json.currentAdvisorSituation }}\nClient's Own Words: {{ $json.freeText }}\n\n## FROM THE PREP BRIEF\nExecutive Summary: {{ $json.executiveSummary }}\nFinancial Snapshot: {{ JSON.stringify($json.financialSnapshot) }}\nGoal Analysis: {{ JSON.stringify($json.goalAnalysis) }}\nClient Psychology: {{ JSON.stringify($json.clientPsychologyNotes) }}\nCompetitive Intel: {{ $json.competitiveIntelligence }}\nDocuments to Request: {{ JSON.stringify($json.documentsToRequest) }}\n\n## MEETING DETAILS\nDate: {{ $json.formattedDate }}\nTime: {{ $json.formattedTime }} ET\nAdvisor: {{ $json.advisorName }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are a senior relationship manager at NorthStar Wealth Advisory drafting personalized pre-meeting emails. These emails go out 24-48 hours before a first consultation to build rapport and set the stage for a productive meeting.\n\n## YOUR GOAL\nMake the client feel like their advisor has ALREADY invested time in understanding their situation. This is the first personal touchpoint — it sets the tone for the entire relationship. The client should think: \"This person actually read my file.\"\n\n## TONE\n- Warm but professional. Not salesy. Not stiff.\n- Like a thoughtful colleague who happens to be great with money.\n- Show genuine intellectual curiosity about their financial situation.\n- Mirror the sophistication level of their asset range (don't talk down to a $500K+ client).\n\n## WHAT TO INCLUDE\n1. **Personal acknowledgment** — Reference something specific from their intake (goals, situation, or free text). NOT generic.\n2. **Light insight** — One or two observations that show you've thought about their situation. Not full advice, but enough to signal competence. E.g., \"Given your timeline and the current rate environment, I think we'll have some interesting options to explore around [specific topic].\"\n3. **What to expect** — Brief preview of what the consultation will cover, framed as collaborative (\"I'd love to explore...\" not \"I will tell you...\").\n4. **Gentle ask** — If there are documents that would make the meeting more productive, mention 1-2 (not a laundry list). Frame as optional: \"If you have X handy, it would help us hit the ground running.\"\n5. **Warm close** — Genuine-sounding, not corporate.\n\n## WHAT TO AVOID\n- Generic platitudes (\"We're committed to your financial success\")\n- Anything that sounds like a template\n- Giving actual financial advice (compliance issue)\n- Mentioning risk flags or sensitive observations from the prep brief\n- Being too long — this should be 200-350 words, readable in 90 seconds\n- Using the client's asset numbers or income explicitly (privacy)\n- Overpromising outcomes\n\n## OUTPUT SCHEMA (JSON only)\n{\n  \"subject\": \"Email subject line — personal, not corporate. Use their first name.\",\n  \"body\": \"The full email body as plain text. Use line breaks for paragraphs. Sign off as the advisor. Include advisor name and 'NorthStar Wealth Advisory' in signature.\",\n  \"internalNotes\": \"1-2 sentences for the advisor explaining the strategic angle of this email — what rapport-building goal it serves and what response signals to watch for.\"\n}\n\n## RULES\n- Subject line MUST include the client's first name\n- Body must reference at least ONE specific detail from their intake or prep brief\n- Body must mention the meeting date/time\n- Sign off with the advisor's actual name\n- Output ONLY valid JSON"
        }
      },
      "id": "ebe13a96-de31-4799-a925-48dec5388cdc",
      "name": "Nurture Email Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        25312,
        368
      ]
    },
    {
      "parameters": {
        "modelName": "models/gemini-3.1-pro-preview",
        "options": {
          "temperature": 0.5
        }
      },
      "id": "cc8482c8-8712-44b4-ba93-d0712747aaab",
      "name": "Gemini 2.5 Flash (Nurture)",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        25248,
        608
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "gKOxHvioCsyTdrwX",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{ \"type\": \"object\", \"properties\": { \"subject\": { \"type\": \"string\" }, \"body\": { \"type\": \"string\" }, \"internalNotes\": { \"type\": \"string\" } }, \"required\": [\"subject\", \"body\", \"internalNotes\"] }"
      },
      "id": "6e4bee0e-fd39-407b-9202-8a714ae108ad",
      "name": "Nurture Draft Schema",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        25456,
        608
      ]
    },
    {
      "parameters": {
        "jsCode": "const agentOutput = $('Nurture Email Agent').first().json;\nconst context = $('Build Nurture Prompt').first().json;\n\nconst draft = agentOutput.output\n  ? (typeof agentOutput.output === 'string' ? JSON.parse(agentOutput.output) : agentOutput.output)\n  : agentOutput;\n\nreturn [{ json: {\n  leadId: context.leadId,\n  airtableRecordId: context.airtableRecordId,\n  clientName: context.clientName,\n  clientEmail: context.clientEmail,\n  advisorName: context.advisorName,\n  subject: draft.subject || `Looking forward to our conversation, ${context.clientFirstName}`,\n  body: draft.body || '',\n  internalNotes: draft.internalNotes || '',\n  nurtureEmailStatus: 'PENDING_REVIEW'\n} }];"
      },
      "id": "f2619c1f-35a8-4c60-b6ea-3ce7b20acad0",
      "name": "Process Draft Output",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        25552,
        368
      ]
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "={leadId}='{{ $json.leadId }}'",
        "options": {}
      },
      "id": "b211daff-2b42-4494-9587-01982b68719b",
      "name": "Find Lead for Update",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        26272,
        368
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.id }}",
            "nurtureEmailDraft": "={{ $('Process Guardrails Result').first().json.body }}",
            "nurtureEmailSubject": "={{ $('Process Guardrails Result').first().json.subject }}",
            "nurtureEmailStatus": "={{ $('Process Guardrails Result').first().json.nurtureEmailStatus }}",
            "complianceNotes": "={{ $('Process Guardrails Result').first().json.complianceNotes }}",
            "complianceViolations": "={{ $('Process Guardrails Result').first().json.complianceViolations }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "14efb98d-eb4d-4818-aad9-e76dccc51d04",
      "name": "Save Draft to Airtable",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        26512,
        368
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/nurture/approve",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "e00b27ec-344c-40a5-99fa-b0ded801ea8c",
      "name": "Approve Nurture Email",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        23904,
        992
      ],
      "webhookId": "2b7c79e8-b2df-45f1-99a4-f44000d141fe"
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "={leadId}='{{ $json.body.leadId }}'",
        "options": {}
      },
      "id": "ef957758-9ab1-437f-8920-b2328a960f05",
      "name": "Get Approved Draft",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        24176,
        992
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const record = $input.first().json;\nconst fields = record.fields || record;\nconst leadId = $('Approve Nurture Email').first().json.body.leadId;\n\nconst clientEmail = fields.email || '';\nconst subject = fields.nurtureEmailSubject || '';\nconst body = fields.nurtureEmailDraft || '';\n\n// Build mailto link for the frontend to open native email client\nconst mailtoLink = `mailto:${encodeURIComponent(clientEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;\n\nreturn [{ json: {\n  leadId: fields.leadId || leadId,\n  airtableRecordId: record.id,\n  clientEmail,\n  subject,\n  body,\n  mailtoLink,\n  success: true\n} }];"
      },
      "id": "fff6fa7a-c18f-4527-a69d-d44a9a75996e",
      "name": "Build mailto Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        24416,
        992
      ]
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $('Build mailto Response').first().json.airtableRecordId }}",
            "nurtureEmailStatus": "APPROVED"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "d9e1677b-1dc4-4f5a-b7e4-821266bae8a4",
      "name": "Mark Approved in Airtable",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        24656,
        992
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, mailtoLink: $('Build mailto Response').first().json.mailtoLink, subject: $('Build mailto Response').first().json.subject, body: $('Build mailto Response').first().json.body, clientEmail: $('Build mailto Response').first().json.clientEmail }) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "2b85dc92-816e-4e7b-ac2f-453421eaa59f",
      "name": "Return mailto Link",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        24896,
        992
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/nurture/dismiss",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "4e4a3ca7-71fa-4c77-9e29-ba5bea91432e",
      "name": "Dismiss Nurture Email",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        23904,
        1232
      ],
      "webhookId": "66d10094-ba5e-49da-b0ac-1e7a5bf48b81"
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "={leadId}='{{ $json.body.leadId }}'",
        "options": {}
      },
      "id": "e1c99f46-1c8e-4585-b32e-d2f95962e28a",
      "name": "Get Dismissed Lead",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        24176,
        1232
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.id }}",
            "nurtureEmailStatus": "DISMISSED"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "95123dad-e58d-41f0-acf0-e8d34636cd3d",
      "name": "Mark Dismissed in Airtable",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        24416,
        1232
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, status: 'DISMISSED' }) }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": "c357e1fe-2d30-4132-819f-9de6ef1ce890",
      "name": "Return Dismiss Ack",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        24656,
        1232
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Review the following client-facing email draft for compliance with NorthStar Wealth Advisory policies.\n\n## EMAIL TO REVIEW\nSubject: {{ $json.subject }}\n\nBody:\n{{ $json.body }}\n\n## CONTEXT\nThis email is from advisor {{ $json.advisorName }} to prospective client {{ $json.clientName }}.\nThe client has NOT yet been accepted — this is a pre-meeting rapport email.",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are a compliance review agent for NorthStar Wealth Advisory. Your job is to check outbound client-facing emails against firm policies BEFORE they are sent.\n\n## CRITICAL: USE THE COMPLIANCE POLICY TOOL\nYou MUST query the 'Compliance Policy Docs' tool to retrieve relevant compliance rules before making your assessment. Query for:\n1. Client communication standards and prohibited language\n2. Pre-engagement compliance requirements (what can/cannot be said before a client is formally onboarded)\n3. Financial advice boundaries and disclaimer requirements\n\n## CHECK FOR THESE VIOLATIONS\n1. **Specific financial advice** — Any concrete investment recommendations, specific product suggestions, or return projections before formal engagement\n2. **Guarantees or promises** — Language implying guaranteed outcomes, specific returns, or assured results\n3. **Misleading claims** — Overstating advisor qualifications, firm capabilities, or past performance\n4. **Privacy violations** — Mentioning specific asset amounts, income figures, or sensitive personal details the client shared in confidence\n5. **Regulatory issues** — Missing required disclaimers, unauthorized use of credentials/titles, or claims that violate MFDA/CSA advertising rules\n6. **Inappropriate tone** — Overly aggressive sales language, pressure tactics, fear-based urgency, or anything that could be perceived as coercive\n7. **Competitor disparagement** — Negative statements about other advisors or firms\n8. **Unauthorized commitments** — Promising specific meeting outcomes, fee structures, or services not yet discussed with the client\n\n## OUTPUT (JSON only)\n{\n  \"approved\": true/false,\n  \"overallAssessment\": \"PASS | MINOR_ISSUES | MAJOR_VIOLATIONS\",\n  \"violations\": [\n    {\n      \"type\": \"category from above\",\n      \"excerpt\": \"the problematic text from the email\",\n      \"explanation\": \"why this violates policy\",\n      \"severity\": \"LOW | MEDIUM | HIGH\",\n      \"suggestedFix\": \"how to fix it\"\n    }\n  ],\n  \"revisedSubject\": \"corrected subject if needed, otherwise original\",\n  \"revisedBody\": \"full corrected email body if any violations found, otherwise original body unchanged\",\n  \"complianceNotes\": \"1-2 sentence summary for the advisor explaining what was checked and any changes made\"\n}\n\n## RULES\n- approved=true ONLY if overallAssessment is PASS\n- If MINOR_ISSUES: approved=false, provide revisedBody with fixes applied\n- If MAJOR_VIOLATIONS: approved=false, provide revisedBody with fixes, flag for human review\n- Empty violations array = PASS\n- Be thorough but not overly restrictive — warm, personal emails are the GOAL, just without compliance issues\n- Do NOT strip personality or warmth from the email unless it crosses a compliance line\n- Output ONLY valid JSON"
        }
      },
      "id": "fd88054f-7d91-4090-a45a-c5d39ee4b964",
      "name": "Compliance Guardrails Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        25792,
        368
      ]
    },
    {
      "parameters": {
        "options": {
          "temperature": 0.1
        }
      },
      "id": "f07e3e1a-d74a-4c93-98fb-a36f37ed79ac",
      "name": "Gemini 2.5 Flash (Guardrails)",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        25728,
        608
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "gKOxHvioCsyTdrwX",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{ \"type\": \"object\", \"properties\": { \"approved\": { \"type\": \"boolean\" }, \"overallAssessment\": { \"type\": \"string\", \"enum\": [\"PASS\", \"MINOR_ISSUES\", \"MAJOR_VIOLATIONS\"] }, \"violations\": { \"type\": \"array\", \"items\": { \"type\": \"object\", \"properties\": { \"type\": { \"type\": \"string\" }, \"excerpt\": { \"type\": \"string\" }, \"explanation\": { \"type\": \"string\" }, \"severity\": { \"type\": \"string\", \"enum\": [\"LOW\", \"MEDIUM\", \"HIGH\"] }, \"suggestedFix\": { \"type\": \"string\" } }, \"required\": [\"type\", \"excerpt\", \"explanation\", \"severity\", \"suggestedFix\"] } }, \"revisedSubject\": { \"type\": \"string\" }, \"revisedBody\": { \"type\": \"string\" }, \"complianceNotes\": { \"type\": \"string\" } }, \"required\": [\"approved\", \"overallAssessment\", \"violations\", \"revisedSubject\", \"revisedBody\", \"complianceNotes\"] }"
      },
      "id": "1d5147a8-e095-4272-9b6b-93620ee72dad",
      "name": "Guardrails Output Schema",
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        26496,
        608
      ]
    },
    {
      "parameters": {
        "description": "NorthStar Wealth Advisory compliance and communication policy documents. Contains: client communication standards, pre-engagement rules, prohibited language and claims, MFDA/CSA advertising compliance requirements, disclaimer requirements, privacy and confidentiality rules, financial advice boundaries for pre-engagement communications, and vulnerable client communication guidelines. Query this tool to check email drafts against firm policies.",
        "topK": 6
      },
      "id": "de19a043-6408-4e83-b03b-0c111b3a935d",
      "name": "Compliance Policy Docs",
      "type": "@n8n/n8n-nodes-langchain.toolVectorStore",
      "typeVersion": 1.1,
      "position": [
        25904,
        656
      ]
    },
    {
      "parameters": {
        "pineconeIndex": {
          "__rl": true,
          "mode": "list",
          "value": "northstar-policies",
          "cachedResultName": "northstar-policies"
        },
        "options": {}
      },
      "id": "38a5357f-f873-4be9-b61f-f38be6389850",
      "name": "Pinecone (Compliance Check)",
      "type": "@n8n/n8n-nodes-langchain.vectorStorePinecone",
      "typeVersion": 1,
      "position": [
        25760,
        848
      ],
      "credentials": {
        "pineconeApi": {
          "id": "yIemhxUEm2rJwniw",
          "name": "PineconeApi account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "models/gemini-embedding-001"
      },
      "id": "114d15a9-e60b-4215-9691-0ab11a45bb15",
      "name": "Embeddings Gemini (Compliance)",
      "type": "@n8n/n8n-nodes-langchain.embeddingsGoogleGemini",
      "typeVersion": 1,
      "position": [
        25696,
        1024
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "gKOxHvioCsyTdrwX",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const guardrailsRaw = $('Compliance Guardrails Agent').first().json;\nconst original = $('Process Draft Output').first().json;\n\n// Parse guardrails output\nconst result = guardrailsRaw.output\n  ? (typeof guardrailsRaw.output === 'string' ? JSON.parse(guardrailsRaw.output) : guardrailsRaw.output)\n  : guardrailsRaw;\n\nconst approved = result.approved === true;\nconst assessment = result.overallAssessment || 'PASS';\n\n// Use revised text if there were issues, otherwise keep original\nconst finalSubject = (!approved && result.revisedSubject) ? result.revisedSubject : original.subject;\nconst finalBody = (!approved && result.revisedBody) ? result.revisedBody : original.body;\n\nreturn [{ json: {\n  // Pass through all original fields\n  leadId: original.leadId,\n  airtableRecordId: original.airtableRecordId,\n  clientName: original.clientName,\n  clientEmail: original.clientEmail,\n  advisorName: original.advisorName,\n  internalNotes: original.internalNotes,\n  // Final email content (revised if needed)\n  subject: finalSubject,\n  body: finalBody,\n  // Compliance metadata\n  complianceApproved: approved,\n  complianceAssessment: assessment,\n  complianceNotes: result.complianceNotes || '',\n  complianceViolations: JSON.stringify(result.violations || []),\n  // Status depends on result\n  nurtureEmailStatus: approved ? 'PENDING_REVIEW' : (assessment === 'MAJOR_VIOLATIONS' ? 'COMPLIANCE_FLAGGED' : 'PENDING_REVIEW')\n} }];"
      },
      "id": "243e1da5-d159-4d2f-ab99-de3801bd0995",
      "name": "Process Guardrails Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        26128,
        368
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        26224,
        848
      ],
      "id": "32693f15-8db5-49bd-a1da-45efb99d4431",
      "name": "Google Gemini Chat Model1",
      "credentials": {
        "googlePalmApi": {
          "id": "gKOxHvioCsyTdrwX",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "content": "# WF12: NURTURE EMAIL SEND\n\n**Trigger:** POST /api/nurture/send from admin dashboard\n\n**Payload:** { leadId, to, subject, body }\n\n**Flow:**\n1. Receive webhook with email content\n2. Send email via Gmail\n3. Update lead in Airtable (nurtureEmailStatus → SENT)\n4. Return success/failure to frontend\n\n**Error handling:** Returns 500 with error message on failure",
        "height": 648,
        "width": 1872,
        "color": 2
      },
      "id": "3c8f5b92-3405-4422-8c82-e6999218f45e",
      "name": "WF12 Overview",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        26848,
        352
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/nurture/send",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*"
        }
      },
      "id": "8e40f3f8-056b-4cea-a1f9-a8df39095c6b",
      "name": "POST /api/nurture/send",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        27008,
        656
      ],
      "webhookId": "nurture-send",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "version": 2,
            "leftValue": "",
            "caseSensitive": true,
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "cond-1",
              "leftValue": "={{ $json.body.to }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isNotEmpty",
                "singleValue": true
              }
            },
            {
              "id": "cond-2",
              "leftValue": "={{ $json.body.subject }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isNotEmpty",
                "singleValue": true
              }
            },
            {
              "id": "cond-3",
              "leftValue": "={{ $json.body.body }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isNotEmpty",
                "singleValue": true
              }
            },
            {
              "id": "cond-4",
              "leftValue": "={{ $json.body.leadId }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isNotEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "e49e13b9-62a5-4d05-a20b-47c4059c39f8",
      "name": "Validate Payload",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        27296,
        656
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, message: 'Missing required fields: to, subject, body, leadId' }) }}",
        "options": {
          "responseCode": 400,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "id": "8d84187b-5b03-4122-8be2-38008539acf5",
      "name": "Return 400 (Invalid)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        27536,
        800
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $('POST /api/nurture/send').first().json.body;\n\n// Wrap plain text body in HTML that preserves line breaks\nconst htmlBody = `<div style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; color: #1a1a2e;\">\n<div style=\"background: #0a2540; padding: 24px 32px; border-radius: 12px 12px 0 0;\">\n<h1 style=\"color: #ffffff; font-size: 20px; font-weight: 600; margin: 0;\">NorthStar Wealth Advisory</h1>\n</div>\n<div style=\"background: #ffffff; padding: 28px 32px; border: 1px solid #e8e8e8; border-top: none;\">\n<pre style=\"font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; white-space: pre-wrap; word-wrap: break-word; font-size: 15px; line-height: 1.6; margin: 0; color: #1a1a2e;\">${input.body}</pre>\n</div>\n<div style=\"padding: 16px 32px; text-align: center; font-size: 12px; color: #9ca3af;\">NorthStar Wealth Advisory · Toronto, ON</div>\n</div>`;\n\nreturn [{ json: {\n  leadId: input.leadId,\n  to: input.to,\n  subject: input.subject,\n  body: input.body,\n  htmlBody\n} }];"
      },
      "id": "85f3c7cb-8886-4340-9831-14cabb1fa8fd",
      "name": "Prep Email Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        27536,
        608
      ]
    },
    {
      "parameters": {
        "sendTo": "={{ $json.to }}",
        "subject": "={{ $json.subject }}",
        "message": "={{ $json.htmlBody }}",
        "options": {
          "appendAttribution": false
        }
      },
      "id": "7e39c027-2974-45e7-8d00-a80729b82b71",
      "name": "Send Nurture Email",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        27776,
        608
      ],
      "webhookId": "4e88e0e8-4899-431c-94d2-839c27828b04",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "id": "={{ $json.id }}",
            "nurtureEmailStatus": "SENT",
            "lastEmailSentAt": "={{ new Date().toISOString() }}"
          },
          "matchingColumns": [
            "id"
          ],
          "schema": [
            {
              "id": "id",
              "displayName": "id",
              "required": false,
              "defaultMatch": true,
              "display": true,
              "type": "string",
              "readOnly": true,
              "removed": false,
              "canBeUsedToMatch": true
            }
          ]
        },
        "options": {}
      },
      "id": "cd945044-f9f5-48ff-9650-6bed75b3e895",
      "name": "Update Nurture Status",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        28256,
        608
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: true, message: 'Nurture email sent successfully', leadId: $('Prep Email Data').first().json.leadId }) }}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "id": "09b91349-e4c1-4513-af67-684df5cc238e",
      "name": "Return 200 (Success)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        28496,
        608
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({ success: false, message: 'Failed to send nurture email' }) }}",
        "options": {
          "responseCode": 500,
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "GET, POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "id": "bb4a76ef-a57a-49d5-a412-ba92516718ba",
      "name": "Return 500 (Error)",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.5,
      "position": [
        28016,
        848
      ]
    },
    {
      "parameters": {
        "operation": "search",
        "base": {
          "__rl": true,
          "value": "appRvAEh3HHEra8gz",
          "mode": "id"
        },
        "table": {
          "__rl": true,
          "value": "tblEPuNDRprzezbK1",
          "mode": "id"
        },
        "filterByFormula": "={leadId}='{{ $('Prep Email Data').first().json.leadId }}'",
        "options": {}
      },
      "id": "0f12964e-3ecd-43d2-8462-962f59e032dd",
      "name": "Find Lead in Airtable1",
      "type": "n8n-nodes-base.airtable",
      "typeVersion": 2.1,
      "position": [
        28016,
        608
      ],
      "credentials": {
        "airtableTokenApi": {
          "id": "CP9rcRyd72mNUa9G",
          "name": "Airtable Personal Access Token account"
        }
      }
    },
    {
      "parameters": {
        "content": "## WF13 - Compliance Document Ingestion (RAG)\n\n**Purpose:** Watches a Google Drive folder for new/updated compliance documents and embeds them into Pinecone vector store for use by WF2 (enrichment) and WF11 (guardrails).\n\n**Based on template by Mihai Farcas** (@mihailtd). View at: https://n8n.io/workflows/2753\n\n**Flow:**\n1. Google Drive Trigger detects new/updated files in 'NorthStar Compliance' folder\n2. Downloads the file (PDF, DOCX, etc.)\n3. Loads document content via Default Data Loader\n4. Splits into chunks (1000 chars, 200 overlap)\n5. Embeds with Google Gemini text-embedding-004\n6. Inserts into Pinecone index 'northstar-policies'\n\n**Credentials needed:** Google Drive OAuth2, Pinecone API, Google Gemini API",
        "height": 1688,
        "width": 1872,
        "color": 6
      },
      "id": "c69baabb-f70b-470e-999f-97fd2eb00e01",
      "name": "WF13 Overview",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        28720,
        -112
      ]
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "triggerOn": "specificFolder",
        "folderToWatch": {
          "__rl": true,
          "mode": "id",
          "value": "1ERGkYZs-GOntYtP2vCHJ7Y1jM5yJhmt0"
        },
        "event": "fileCreated",
        "options": {
          "fileType": "all"
        }
      },
      "id": "840ec138-dd9b-406a-8514-7cafdec717fb",
      "name": "New Compliance Doc",
      "type": "n8n-nodes-base.googleDriveTrigger",
      "typeVersion": 1,
      "position": [
        29136,
        320
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "5BB7fi2VhZAQm1VG",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "triggerOn": "specificFolder",
        "folderToWatch": {
          "__rl": true,
          "mode": "id",
          "value": "1ERGkYZs-GOntYtP2vCHJ7Y1jM5yJhmt0"
        },
        "event": "fileUpdated",
        "options": {}
      },
      "id": "b94c5402-f7dd-40b3-a499-271c86354557",
      "name": "Updated Compliance Doc",
      "type": "n8n-nodes-base.googleDriveTrigger",
      "typeVersion": 1,
      "position": [
        29136,
        640
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "5BB7fi2VhZAQm1VG",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "operation": "download",
        "fileId": {
          "__rl": true,
          "mode": "id",
          "value": "={{ $json.id }}"
        },
        "options": {
          "fileName": "={{ $json.name }}"
        }
      },
      "id": "cc073968-7345-4ad7-87f4-8a3a971792a9",
      "name": "Download File",
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        29392,
        640
      ],
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "5BB7fi2VhZAQm1VG",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "mode": "insert",
        "pineconeIndex": {
          "__rl": true,
          "mode": "list",
          "value": "northstar-policies",
          "cachedResultName": "northstar-policies"
        },
        "options": {}
      },
      "id": "381f4cbc-69d3-44ea-b8ed-c296364036e4",
      "name": "Pinecone Vector Store",
      "type": "@n8n/n8n-nodes-langchain.vectorStorePinecone",
      "typeVersion": 1,
      "position": [
        29664,
        640
      ],
      "credentials": {
        "pineconeApi": {
          "id": "yIemhxUEm2rJwniw",
          "name": "PineconeApi account"
        }
      }
    },
    {
      "parameters": {
        "modelName": "models/gemini-embedding-001"
      },
      "id": "3b9b0618-5d0c-497a-9862-fbf1a8cc6fea",
      "name": "Embeddings Google Gemini",
      "type": "@n8n/n8n-nodes-langchain.embeddingsGoogleGemini",
      "typeVersion": 1,
      "position": [
        29552,
        880
      ],
      "credentials": {
        "googlePalmApi": {
          "id": "gKOxHvioCsyTdrwX",
          "name": "Google Gemini(PaLM) Api account"
        }
      }
    },
    {
      "parameters": {
        "dataType": "binary",
        "binaryMode": "specificField",
        "options": {}
      },
      "id": "2e80aa81-a5ce-4201-9edb-3e2b58e8ad80",
      "name": "Default Data Loader",
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1,
      "position": [
        29936,
        864
      ]
    },
    {
      "parameters": {
        "chunkOverlap": 200,
        "options": {}
      },
      "id": "af72af04-ff1a-4684-8bb7-af8bc8a4e6d6",
      "name": "Recursive Character Text Splitter",
      "type": "@n8n/n8n-nodes-langchain.textSplitterRecursiveCharacterTextSplitter",
      "typeVersion": 1,
      "position": [
        30272,
        1072
      ]
    },
    {
      "parameters": {
        "jsCode": "const error = $input.first().json;\nreturn [{\n  json: {\n    workflow: 'WF13',\n    error: error.message || 'Unknown ingestion error',\n    timestamp: new Date().toISOString(),\n    context: 'Compliance document ingestion failed'\n  }\n}];"
      },
      "id": "493d4121-2da0-4260-9575-3c28fb8210f7",
      "name": "Handle Ingestion Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        29632,
        1232
      ]
    },
    {
      "parameters": {
        "sendTo": "smuharsk@gmail.com",
        "subject": "=⚠️ WF13 Ingestion Error - {{ $json.timestamp }}",
        "message": "=Compliance document ingestion failed.\n\nError: {{ $json.error }}\nContext: {{ $json.context }}\nTimestamp: {{ $json.timestamp }}\n\nPlease check the n8n execution log for details.",
        "options": {}
      },
      "id": "49e95b69-8b86-44a7-ab55-3e04790f90bc",
      "name": "Send Ingestion Error Alert",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [
        29872,
        1232
      ],
      "webhookId": "a0826ea7-32b2-4651-99bc-54d40512ff2f",
      "credentials": {
        "gmailOAuth2": {
          "id": "dnECY8GMehNvK0Ok",
          "name": "Gmail account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Simulate the Google Drive trigger output for manual testing\n// This targets the NorthStar Comprehensive Policy Manual PDF\nreturn [{\n  json: {\n    id: '1th3flQWlVI2VDpCp8HdJP5t_SL_lQoRU',\n    name: 'NorthStar_Comprehensive_Policy_Manual.pdf',\n    mimeType: 'application/pdf'\n  }\n}];"
      },
      "id": "68d46cb5-784f-4e73-8025-281a21bd4415",
      "name": "Set Test File ID",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        29120,
        928
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Intake Form Webhook": {
      "main": [
        [
          {
            "node": "Validate Intake Form",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Intake Form": {
      "main": [
        [
          {
            "node": "Valid?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Valid?": {
      "main": [
        [
          {
            "node": "Generate Lead ID",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Return 400",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Lead ID": {
      "main": [
        [
          {
            "node": "Get Firm Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Firm Config": {
      "main": [
        [
          {
            "node": "Disqualification Rules Engine",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Disqualification Rules Engine": {
      "main": [
        [
          {
            "node": "Disqualification Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Redis State (Qualified)": {
      "main": [
        [
          {
            "node": "Set Lead State (Redis)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Lead State (Redis)": {
      "main": [
        [
          {
            "node": "Create Lead in Airtable (Qualified)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Lead in Airtable (Qualified)": {
      "main": [
        [
          {
            "node": "Return 200 (Qualified)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Trigger WF2 - Enrichment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Redis State (Disqualified)": {
      "main": [
        [
          {
            "node": "Set Lead State (Disqualified)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Lead State (Disqualified)": {
      "main": [
        [
          {
            "node": "Create Lead in Airtable (Disqualified)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Lead in Airtable (Disqualified)": {
      "main": [
        [
          {
            "node": "Return 200 (Disqualified)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Catch WF1 Errors": {
      "main": [
        [
          {
            "node": "Send WF1 Error Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Disqualification Router": {
      "main": [
        [
          {
            "node": "Prep Redis State (Disqualified)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prep Redis State (Qualified)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Called from WF1": {
      "main": [
        [
          {
            "node": "Get Lead from Airtable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Lead from Airtable": {
      "main": [
        [
          {
            "node": "Verify Lead Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verify Lead Status": {
      "main": [
        [
          {
            "node": "Get Advisors Cache",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Advisors Cache": {
      "main": [
        [
          {
            "node": "Get Service Tiers Cache",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Service Tiers Cache": {
      "main": [
        [
          {
            "node": "Merge Lead + Business Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Lead + Business Data": {
      "main": [
        [
          {
            "node": "Lead Enrichment Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lead Enrichment Agent": {
      "main": [
        [
          {
            "node": "Merge Enrichment Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini 2.5 Flash (Enrichment)": {
      "ai_languageModel": [
        [
          {
            "node": "Lead Enrichment Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Lead Enrichment Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Merge Enrichment Results": {
      "main": [
        [
          {
            "node": "Update Lead in Airtable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Enrichment Error": {
      "main": [
        [
          {
            "node": "Send WF2 Error Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Lead in Airtable": {
      "main": [
        [
          {
            "node": "Trigger WF3 - Availability",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Firm Policy Knowledge": {
      "ai_tool": [
        [
          {
            "node": "Lead Enrichment Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Pinecone (Policy Retrieval)": {
      "ai_vectorStore": [
        [
          {
            "node": "Firm Policy Knowledge",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Gemini (Retrieval)": {
      "ai_embedding": [
        [
          {
            "node": "Pinecone (Policy Retrieval)",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "Firm Policy Knowledge",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Get Availability Cache": {
      "main": [
        [
          {
            "node": "Get Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Config": {
      "main": [
        [
          {
            "node": "Check Preferred & Backup Availability",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Preferred & Backup Availability": {
      "main": [
        [
          {
            "node": "Find Lead in Airtable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Lead in Airtable": {
      "main": [
        [
          {
            "node": "Prep Airtable Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Airtable Update": {
      "main": [
        [
          {
            "node": "Update Lead in Airtable (Status)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "POST /api/leads/approve": {
      "main": [
        [
          {
            "node": "Process Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Approval": {
      "main": [
        [
          {
            "node": "Find Lead (Approve)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Lead (Approve)": {
      "main": [
        [
          {
            "node": "Prep Approve Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Approve Update": {
      "main": [
        [
          {
            "node": "Update Lead (Approve)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Lead (Approve)": {
      "main": [
        [
          {
            "node": "Return 200 (Approve)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Trigger WF5 - Outreach",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "POST /api/leads/reject": {
      "main": [
        [
          {
            "node": "Parse Reject",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Reject": {
      "main": [
        [
          {
            "node": "Find Lead (Reject)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Lead (Reject)": {
      "main": [
        [
          {
            "node": "Prep Reject Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Reject Update": {
      "main": [
        [
          {
            "node": "Update Lead (Reject)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Lead (Reject)": {
      "main": [
        [
          {
            "node": "Return 200 (Reject)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Trigger WF8 - Rejection Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "POST /api/leads/override": {
      "main": [
        [
          {
            "node": "Parse Override",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Override": {
      "main": [
        [
          {
            "node": "Find Lead (Override)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Lead (Override)": {
      "main": [
        [
          {
            "node": "Prep Override Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Override Update": {
      "main": [
        [
          {
            "node": "Update Lead (Override)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Lead (Override)": {
      "main": [
        [
          {
            "node": "Return 200 (Override)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Trigger WF2 - Enrich Override",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "POST /api/leads/request-info": {
      "main": [
        [
          {
            "node": "Parse Info Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Info Request": {
      "main": [
        [
          {
            "node": "Find Lead (Info)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Lead (Info)": {
      "main": [
        [
          {
            "node": "Prep Info Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Info Update": {
      "main": [
        [
          {
            "node": "Update Lead (Info)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Lead (Info)": {
      "main": [
        [
          {
            "node": "Return 200 (Info)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GET /api/leads/disqualified": {
      "main": [
        [
          {
            "node": "Fetch DQ Leads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch DQ Leads": {
      "main": [
        [
          {
            "node": "Format DQ Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format DQ Response": {
      "main": [
        [
          {
            "node": "Return DQ Leads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "POST /api/leads/confirm-reject": {
      "main": [
        [
          {
            "node": "Parse Confirm Reject",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Confirm Reject": {
      "main": [
        [
          {
            "node": "Find Lead (Confirm Reject)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Lead (Confirm Reject)": {
      "main": [
        [
          {
            "node": "Update Lead (Confirm Reject)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Lead (Confirm Reject)": {
      "main": [
        [
          {
            "node": "Return 200 (Confirm Reject)",
            "type": "main",
            "index": 0
          },
          {
            "node": "Trigger WF8 - Confirmed Rejection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Lead Data": {
      "main": [
        [
          {
            "node": "Time Available?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Time Available?": {
      "main": [
        [
          {
            "node": "Build Confirmation Email",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Scheduling Outreach",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Confirmation Email": {
      "main": [
        [
          {
            "node": "Send Confirmation Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Confirmation Email": {
      "main": [
        [
          {
            "node": "Log Appointment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Appointment": {
      "main": [
        [
          {
            "node": "Update Lead BOOKED",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Lead BOOKED": {
      "main": [
        [
          {
            "node": "Trigger WF10 - Prep Brief",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Scheduling Outreach": {
      "main": [
        [
          {
            "node": "Send Outreach Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Outreach Email": {
      "main": [
        [
          {
            "node": "Update Lead OUTREACH",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Lead from Airtable1": {
      "main": [
        [
          {
            "node": "Prep Lead Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gmail Trigger - New Replies": {
      "main": [
        [
          {
            "node": "Match Email to Lead (Airtable)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Match Email to Lead (Airtable)": {
      "main": [
        [
          {
            "node": "Lead Found?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Lead Found?": {
      "main": [
        [
          {
            "node": "In Outreach?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "In Outreach?": {
      "main": [
        [
          {
            "node": "Prep Parser Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Parser Context": {
      "main": [
        [
          {
            "node": "Email Reply Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email Reply Parser": {
      "main": [
        [
          {
            "node": "Route by Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini (Parser)": {
      "ai_languageModel": [
        [
          {
            "node": "Email Reply Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Reply Parser Schema": {
      "ai_outputParser": [
        [
          {
            "node": "Email Reply Parser",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Route by Action": {
      "main": [
        [
          {
            "node": "Prep Selected Booking",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Prep Cancel",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Clarification",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Build Clarification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Selected Booking": {
      "main": [
        [
          {
            "node": "Send Booking Confirmation",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Booking Confirmation": {
      "main": [
        [
          {
            "node": "Set BOOKED",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set BOOKED": {
      "main": [
        [
          {
            "node": "Find Lead (Book Reply)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Lead (Book Reply)": {
      "main": [
        [
          {
            "node": "Update Lead (BOOKED Reply)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Lead (BOOKED Reply)": {
      "main": [
        [
          {
            "node": "Trigger WF10 - Prep Brief1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Cancel": {
      "main": [
        [
          {
            "node": "Send Cancel Ack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Cancel Ack": {
      "main": [
        [
          {
            "node": "Set CANCELLED",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Clarification": {
      "main": [
        [
          {
            "node": "Send Clarification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Clarification": {
      "main": [
        [
          {
            "node": "Update lastEmailSentAt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Every 1 Hour": {
      "main": [
        [
          {
            "node": "Fetch Actionable Leads (Airtable)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Actionable Leads (Airtable)": {
      "main": [
        [
          {
            "node": "Determine Follow-Up Actions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Determine Follow-Up Actions": {
      "main": [
        [
          {
            "node": "Route Action",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Route Action": {
      "main": [
        [
          {
            "node": "Send Follow-Up #1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Send Follow-Up #2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Find Lead (Unresponsive)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Trigger WF8 - Rejection Email1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Follow-Up #1": {
      "main": [
        [
          {
            "node": "Find Lead (FU1)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Follow-Up #2": {
      "main": [
        [
          {
            "node": "Find Lead (FU2)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Lead (FU1)": {
      "main": [
        [
          {
            "node": "Update Lead (FU1)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Lead (FU1)": {
      "main": [
        [
          {
            "node": "Redis Update (FU1)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Lead (FU2)": {
      "main": [
        [
          {
            "node": "Update Lead (FU2)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Lead (FU2)": {
      "main": [
        [
          {
            "node": "Redis Update (FU2)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Lead (Unresponsive)": {
      "main": [
        [
          {
            "node": "Update Lead (Unresponsive)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Lead (Unresponsive)": {
      "main": [
        [
          {
            "node": "Redis Set UNRESPONSIVE",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Lead (DQ)": {
      "main": [
        [
          {
            "node": "Update Lead (DQ Sent)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Lead (DQ Sent)": {
      "main": [
        [
          {
            "node": "Redis Mark DQ Sent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Trigger WF8 - Rejection Email1": {
      "main": [
        [
          {
            "node": "Find Lead (DQ)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Lead State": {
      "main": [
        [
          {
            "node": "Prep Rejection Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Rejection Context": {
      "main": [
        [
          {
            "node": "Rejection Email Composer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rejection Email Composer": {
      "main": [
        [
          {
            "node": "Build Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini (Rejection)": {
      "ai_languageModel": [
        [
          {
            "node": "Rejection Email Composer",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Build Email": {
      "main": [
        [
          {
            "node": "Send Rejection Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Rejection Email": {
      "main": [
        [
          {
            "node": "Mark Rejection Sent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fallback Template": {
      "main": [
        [
          {
            "node": "Send Fallback Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Every 6 Hours": {
      "main": [
        [
          {
            "node": "Set Trigger Flag",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook - Cache Refresh": {
      "main": [
        [
          {
            "node": "Set Trigger Flag",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Manual Trigger": {
      "main": [
        [
          {
            "node": "Set Trigger Flag",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Trigger Flag": {
      "main": [
        [
          {
            "node": "Fetch Advisor Info (Airtable)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Advisor Info (Airtable)": {
      "main": [
        [
          {
            "node": "Fetch Consultation Services (Airtable)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Consultation Services (Airtable)": {
      "main": [
        [
          {
            "node": "Fetch Advisor Availability (Airtable)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Advisor Availability (Airtable)": {
      "main": [
        [
          {
            "node": "Fetch Configuration (Airtable)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Configuration (Airtable)": {
      "main": [
        [
          {
            "node": "Fetch Email Templates (Airtable)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Email Templates (Airtable)": {
      "main": [
        [
          {
            "node": "Build Cache Objects",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Cache Objects": {
      "main": [
        [
          {
            "node": "Cache Advisors",
            "type": "main",
            "index": 0
          },
          {
            "node": "Cache Service Tiers",
            "type": "main",
            "index": 0
          },
          {
            "node": "Cache Availability",
            "type": "main",
            "index": 0
          },
          {
            "node": "Cache Config",
            "type": "main",
            "index": 0
          },
          {
            "node": "Cache Email Templates",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cache Config": {
      "main": [
        [
          {
            "node": "Log Refresh Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Log Refresh Success": {
      "main": [
        [
          {
            "node": "Write System Log (Airtable)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Daily 7 AM ET": {
      "main": [
        [
          {
            "node": "Find Upcoming Appointments",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Upcoming Appointments": {
      "main": [
        [
          {
            "node": "Any Leads to Prep?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Any Leads to Prep?": {
      "main": [
        [
          {
            "node": "Merge to Common Path",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge to Common Path": {
      "main": [
        [
          {
            "node": "Get Advisors + Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Advisors + Config": {
      "main": [
        [
          {
            "node": "Get Firm Config1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build AI Prompt": {
      "main": [
        [
          {
            "node": "Consultation Prep Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consultation Prep Agent": {
      "main": [
        [
          {
            "node": "Process Brief Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini 2.5 Flash (Prep)": {
      "ai_languageModel": [
        [
          {
            "node": "Consultation Prep Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Prep Brief Schema": {
      "ai_outputParser": [
        [
          {
            "node": "Consultation Prep Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Process Brief Output": {
      "main": [
        [
          {
            "node": "Find Lead Record",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Lead Record": {
      "main": [
        [
          {
            "node": "Save Brief to Airtable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Brief to Airtable": {
      "main": [
        [
          {
            "node": "Email Brief to Advisor",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Email Brief to Advisor": {
      "main": [
        [
          {
            "node": "Trigger WF11 - Nurture Draft",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Prep Error": {
      "main": [
        [
          {
            "node": "Send Error Alert1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Lead from Airtable2": {
      "main": [
        [
          {
            "node": "Merge to Common Path",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Firm Config1": {
      "main": [
        [
          {
            "node": "Build AI Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Lead + Brief": {
      "main": [
        [
          {
            "node": "Build Nurture Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Nurture Prompt": {
      "main": [
        [
          {
            "node": "Nurture Email Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Nurture Email Agent": {
      "main": [
        [
          {
            "node": "Process Draft Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini 2.5 Flash (Nurture)": {
      "ai_languageModel": [
        [
          {
            "node": "Nurture Email Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Nurture Draft Schema": {
      "ai_outputParser": [
        [
          {
            "node": "Nurture Email Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Process Draft Output": {
      "main": [
        [
          {
            "node": "Compliance Guardrails Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Lead for Update": {
      "main": [
        [
          {
            "node": "Save Draft to Airtable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Approve Nurture Email": {
      "main": [
        [
          {
            "node": "Get Approved Draft",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Approved Draft": {
      "main": [
        [
          {
            "node": "Build mailto Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build mailto Response": {
      "main": [
        [
          {
            "node": "Mark Approved in Airtable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark Approved in Airtable": {
      "main": [
        [
          {
            "node": "Return mailto Link",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dismiss Nurture Email": {
      "main": [
        [
          {
            "node": "Get Dismissed Lead",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Dismissed Lead": {
      "main": [
        [
          {
            "node": "Mark Dismissed in Airtable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark Dismissed in Airtable": {
      "main": [
        [
          {
            "node": "Return Dismiss Ack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compliance Guardrails Agent": {
      "main": [
        [
          {
            "node": "Process Guardrails Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini 2.5 Flash (Guardrails)": {
      "ai_languageModel": [
        [
          {
            "node": "Compliance Guardrails Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Guardrails Output Schema": {
      "ai_outputParser": [
        [
          {
            "node": "Compliance Guardrails Agent",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Compliance Policy Docs": {
      "ai_tool": [
        [
          {
            "node": "Compliance Guardrails Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Pinecone (Compliance Check)": {
      "ai_vectorStore": [
        [
          {
            "node": "Compliance Policy Docs",
            "type": "ai_vectorStore",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Gemini (Compliance)": {
      "ai_embedding": [
        [
          {
            "node": "Pinecone (Compliance Check)",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Process Guardrails Result": {
      "main": [
        [
          {
            "node": "Find Lead for Update",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Compliance Policy Docs",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "POST /api/nurture/send": {
      "main": [
        [
          {
            "node": "Validate Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Validate Payload": {
      "main": [
        [
          {
            "node": "Prep Email Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Return 400 (Invalid)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prep Email Data": {
      "main": [
        [
          {
            "node": "Send Nurture Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Nurture Email": {
      "main": [
        [
          {
            "node": "Find Lead in Airtable1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Nurture Status": {
      "main": [
        [
          {
            "node": "Return 200 (Success)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Find Lead in Airtable1": {
      "main": [
        [
          {
            "node": "Update Nurture Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "New Compliance Doc": {
      "main": [
        [
          {
            "node": "Download File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Updated Compliance Doc": {
      "main": [
        [
          {
            "node": "Download File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Download File": {
      "main": [
        [
          {
            "node": "Pinecone Vector Store",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings Google Gemini": {
      "ai_embedding": [
        [
          {
            "node": "Pinecone Vector Store",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "Default Data Loader": {
      "ai_document": [
        [
          {
            "node": "Pinecone Vector Store",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Recursive Character Text Splitter": {
      "ai_textSplitter": [
        [
          {
            "node": "Default Data Loader",
            "type": "ai_textSplitter",
            "index": 0
          }
        ]
      ]
    },
    "Handle Ingestion Error": {
      "main": [
        [
          {
            "node": "Send Ingestion Error Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Test File ID": {
      "main": [
        [
          {
            "node": "Download File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "334ef8a9-54cf-4ec2-bcac-80fd962da7c1",
  "meta": {
    "instanceId": "168c7d7211133de6d8ec393ae7a3e3a882a0d6cfc6397ea1db2fe66f28042b4e"
  },
  "id": "fdS2ezQPMMlvMOuI",
  "tags": []
}